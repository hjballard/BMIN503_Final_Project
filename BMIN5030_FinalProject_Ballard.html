<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>BMIN5030_FinalProject_Ballard</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="BMIN5030_FinalProject_Ballard_files/libs/clipboard/clipboard.min.js"></script>
<script src="BMIN5030_FinalProject_Ballard_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="BMIN5030_FinalProject_Ballard_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="BMIN5030_FinalProject_Ballard_files/libs/quarto-html/popper.min.js"></script>
<script src="BMIN5030_FinalProject_Ballard_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="BMIN5030_FinalProject_Ballard_files/libs/quarto-html/anchor.min.js"></script>
<link href="BMIN5030_FinalProject_Ballard_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="BMIN5030_FinalProject_Ballard_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="BMIN5030_FinalProject_Ballard_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="BMIN5030_FinalProject_Ballard_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="BMIN5030_FinalProject_Ballard_files/libs/bootstrap/bootstrap-bb462d781dde1847d9e3ccf7736099dd.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">BMIN5030_FinalProject_Ballard</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="mapping-the-pallidothalamic-tract-for-focused-ultrasound-therapy-in-parkinsons-disease-a-neuroimaging-quantitative-analysis" class="level2">
<h2 class="anchored" data-anchor-id="mapping-the-pallidothalamic-tract-for-focused-ultrasound-therapy-in-parkinsons-disease-a-neuroimaging-quantitative-analysis">Mapping the Pallidothalamic Tract for Focused Ultrasound Therapy in Parkinson’s Disease: A Neuroimaging Quantitative Analysis</h2>
<p>Hatcher Ballard</p>
</section>
<section id="outline" class="level2">
<h2 class="anchored" data-anchor-id="outline">Outline</h2>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#methods">Methods</a></li>
<li><a href="#pre-processing">Pre-Processing</a></li>
<li><a href="#results-and-analysis">Results and Analysis</a></li>
<li><a href="#limitations">Limitations</a></li>
<li><a href="#conclusion-and-future-directions">Conclusion and Future Directions</a></li>
</ul>
</section>
<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>Parkinson’s Disease (PD) affects more than 10 million people worldwide and incidence continues to grow as the population ages. Despite available medications and deep brain stimulation, many patients still struggle with disabling motor symptoms, highlighting the need for less invasive, targeted therapies. This project examines neuroimaging before and after focused ultrasound ablation of the pallidothalamic tract in patients with PD to better understand predictors of symptom improvement. Specifically, we have analyzed ablation fields, or lesions, to quantify overlap with the ansa lenticularis and lenticular fasciculus, two major output pathways that make up the pallidothalamic tract. We hypothesize that coverage of these tracts results in improved postoperative symptom reduction or resolution.</p>
</section>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>PD is a progressive neurodegenerative disorder characterized by disabling motor symptoms that can become refractory to medication over time. For patients who cannot tolerate or do not benefit from medication and/or deep brain stimulation, focused ultrasound (fUS) ablation has emerged as an effective alternative. Ablation of the pallidothalamic tract (PTT) can provide relief of severe motor symptoms, yet clinical outcomes remain variable, suggesting that subtle anatomic factors within the pallidal outflow pathways may influence response to treatment. Recent literature suggests that targeting the ansa lenticularis and lenticular fasciculus, two downstream tracts, which carry inhibitory outputs through the globus pallidus (GPi) toward thalamic relay nuclei may enhance therapeutic benefit, but these relationships have not been heavily studied. Understanding the impact of ablation of these tracts on patient outcomes may refine fUS targeting and optimize care for PD patients with severe movement symptoms. This problem, and potential solution, involves neurosurgery, radiology, movement disorders neurology, neuroanatomy, and biomedical engineering. High-resolution neuroimaging and tractographic analysis provide the anatomical framework for characterizing ablation lesions, while clinical neuroscience and movement disorders expertise are required to interpret change in symptoms and functional outcomes. By combining anatomical tract analysis, clinical outcome measures, and imaging-driven targeting strategies, this project advances our understanding of fUS ablation impact on basal ganglia circuitry, and how specific white matter tract involvement may drive therapeutic efficacy.</p>
</section>
<section id="methods" class="level2">
<h2 class="anchored" data-anchor-id="methods">Methods</h2>
<p>We analyzed pre-operative and post-operative magnetic resonance imaging (MRI) scans from patients with PD who underwent MR-guided focused ultrasound ablation targeting the pallidothalamic region. Pre-operative imaging was aligned with the corresponding post-treatment lesion mask, generated through manual segmentation. The Dystonia Response Tract Atlas (Horn 2022) was used to define the PTT and its major components: the ansa lenticularis (AL) and lenticular fasciculus (LF), after transformation into each subject’s anatomical space. Lesion and tract masks were re-sampled onto a common grid to enable voxel-wise quantification of tract involvement.</p>
<p>For each subject, we computed lesion volume, tract volumes, and the degree of lesion–tract overlap. Motor outcomes were assessed using changes in UPDRS-III scores before and after treatment. Imaging pre-processing, and all visualization and quality checks were performed using FSL, FSLeyes, ITK-SnAP, and Python on the laboratory processing computer, while final quantitative analyses and modeling were performed in RStudio.</p>
</section>
<section id="pre-processing" class="level2">
<h2 class="anchored" data-anchor-id="pre-processing">Pre-processing</h2>
<p>Prior to subject treatment, the Dystonia Response Tract Atlas (Horn 2022) is registered to the subject’s pre-operative MRI in order to plan the ablation target. This planning is performed using custom in-house software that sets many of the main paths and directories that our research-specific Python scripts reference. It is not appropriate to share the tool that supports clinical planning for the purposes of this assignment (especially as it is being shared to github).</p>
<p>Next, intra-operative and post-operative MRI scans were obtained for each subject, including T1-weighted, T2-weighted, and/or FLAIR sequences depending on clinical protocol. All images were visually inspected in FSLeyes to confirm adequate quality and to verify the ablation lesion.</p>
<p>Pre-operative structural scans were then non-linearly normalized to the MNI152 standard space to enable cross-subject comparison. All available MRI sequences were aligned with the post-operative scan using the Python script shown here, with annotations.</p>
<p>I found RStudio constantly trying to execute my chunks of Python code when rendering and was able to prevent this with “eval: false” and “python.reticulate: false” lines at the top of each Python code chunk.</p>
<div class="cell" data-python.reticulate="false">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">#subjects = list(glob.glob("/home/halpernlab/Targeting/FUS/subjects/preop_immPost/sub*")) # CHANGE PATH</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>subj <span class="op">=</span> sys.argv[<span class="dv">1</span>]</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>subjects <span class="op">=</span> <span class="bu">list</span>(subj.split(<span class="st">","</span>)) <span class="co"># CHANGE PATH if needed, this separates subjects into elements</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>dpSub <span class="op">=</span> subjects  <span class="co"># each element has a directory path</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span> (<span class="bu">len</span>(subjects)):</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># define registration directory for subjects</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    RegDir <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">'preop/ANTS_09c/'</span>) <span class="op">%</span>dpSub[i]</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    dpReg <span class="op">=</span> <span class="bu">str</span>(RegDir)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    mkreg_cmd <span class="op">=</span> <span class="st">'mkdir </span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span>dpReg</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create registration directory if non-existent</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(dpReg):</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>        os.system(mkreg_cmd)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Path to post-op imaging used as reference for all registrations</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    subj_postop <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">'immPost/t2.nii.gz'</span>) <span class="op">%</span>dpSub[i]</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">#------------------------</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PRE-OP T2 -&gt; POST-OP T2</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">#------------------------</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    subj_t2w <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">'preop/t2.nii.gz'</span>) <span class="op">%</span>dpSub[i]</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(subj_t2w):</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'NO T2 AVAILABLE TO MERGE'</span>)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(subj_t2w):</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>      <span class="co"># set naming convention for ANTs output (transform + warped image)</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>        header_t2 <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">"preop/ANTS_09c/t2_to_postop_"</span>) <span class="op">%</span>dpSub[i]</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>        xfm_filename_t2 <span class="op">=</span> header_t2 <span class="op">+</span> <span class="st">"Warped.nii.gz"</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># command to run ANTs registration for T2 -&gt; post-op rigid registration. Could revise to one helper function for future use</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Defining each ANTs command below:</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># dimensionality defines 3D space for registration</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># float controls computational use of 32-bit floats (1) or double precision (0), which is more precise and slower</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># output defines where ANTs saves transformation + warped files</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># interpolation sets interpolation type; NearestNeighbor preserves exact values in the masks</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># winsorize-image-intensities trims intensities below 0.5th percentile and 99.5th percentile; aka removes noise</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># use-histogram-matching: 0 = Off (for multimodal registration like this); 1 = On (for alignment of same-modality images, e.g., T1 -&gt; T1)</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># initial-moving-transform provides starting transformation [fixed, moving, 1 = "use center of mass alignment first"]</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># transform Rigid sets gradient step size to control ANTs optimization; if optimization is too aggressive, you may deform anatomy</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># metric MI (mutual information) defines cost function to evaluate alignment: MI[fixed, moving, weight, nbins, sampling, sampling_param]</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># shrink-factors controls multi-resolution pyramid; starts coarse and then refines</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># convergence sets stopping criteria for each pyramid level = stop early if improvement becomes so small to meet threshold.</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># smoothing-sigmas controls Gaussian smoothing at each resolution level, improving stability at coarse stages</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>        command_t2 <span class="op">=</span> <span class="st">"antsRegistration </span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="er">        --dimensionality 3</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span><span class="bu">float</span> <span class="dv">0</span> </span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>output [<span class="op">%</span>s, <span class="op">%</span>s] </span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>interpolation NearestNeighbor </span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>winsorize<span class="op">-</span>image<span class="op">-</span>intensities [<span class="fl">0.005</span>, <span class="fl">0.995</span>] </span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>use<span class="op">-</span>histogram<span class="op">-</span>matching <span class="dv">0</span> </span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>initial<span class="op">-</span>moving<span class="op">-</span>transform [<span class="op">%</span>s, <span class="op">%</span>s,<span class="dv">1</span>] </span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>transform Rigid[<span class="fl">0.1</span>] </span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>shrink<span class="op">-</span>factors <span class="dv">8</span><span class="er">x4x2x1</span> </span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>metric MI[<span class="op">%</span>s, <span class="op">%</span>s, <span class="dv">1</span>, <span class="dv">32</span>, Regular, <span class="fl">0.25</span>] </span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>convergence [<span class="dv">1000</span><span class="er">x500x250x100</span>,<span class="fl">1e-6</span>,<span class="dv">10</span>] </span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>shrink<span class="op">-</span>factors <span class="dv">8</span><span class="er">x4x2x1</span> </span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>smoothing<span class="op">-</span>sigmas <span class="dv">3</span><span class="er">x2x1x0vox</span> </span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>transform Rigid[<span class="fl">0.1</span>] </span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>metric MI[<span class="op">%</span>s,<span class="op">%</span>s,<span class="dv">1</span>,<span class="dv">32</span>,Regular,<span class="fl">0.25</span>] </span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>convergence [<span class="dv">1000</span><span class="er">x500x250x100</span>,<span class="fl">1e-6</span>,<span class="dv">10</span>] </span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>smoothing<span class="op">-</span>sigmas <span class="dv">3</span><span class="er">x2x1x0vox</span><span class="st">" % (header_t2, xfm_filename_t2, subj_postop, subj_t2w, subj_postop, subj_t2w, subj_postop, subj_t2w)</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a><span class="er">        # if output already exists, skip; otherwise run registration</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> os.path.exists(xfm_filename_t2):</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'T2 already merged to postop'</span>)</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> os.path.exists(xfm_filename_t2):</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>            os.system(command_t2)</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>    <span class="co">#------------------------</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PRE-OP T1 -&gt; POST-OP T2</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>    <span class="co">#------------------------</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># command is repeated specific to MRI sequence being registered</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>        subj_t1 <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">'preop/t1.nii.gz'</span>) <span class="op">%</span>dpSub[i]</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(subj_t1):</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'NO t1 AVAILABLE TO MERGE'</span>)</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(subj_t1):</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>        header_t1 <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">"preop/ANTS_09c/t1_to_postop_"</span>) <span class="op">%</span>dpSub[i]</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>        xfm_filename_t1 <span class="op">=</span> header_t1 <span class="op">+</span> <span class="st">"Warped.nii.gz"</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>        command_t1 <span class="op">=</span> <span class="st">"antsRegistration </span></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a><span class="er">        --dimensionality 3 </span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span><span class="bu">float</span> <span class="dv">0</span> </span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>output [<span class="op">%</span>s, <span class="op">%</span>s] </span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>interpolation NearestNeighbor </span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>winsorize<span class="op">-</span>image<span class="op">-</span>intensities [<span class="fl">0.005</span>, <span class="fl">0.995</span>] </span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>use<span class="op">-</span>histogram<span class="op">-</span>matching <span class="dv">0</span> </span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>initial<span class="op">-</span>moving<span class="op">-</span>transform [<span class="op">%</span>s, <span class="op">%</span>s,<span class="dv">1</span>] </span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>transform Rigid[<span class="fl">0.1</span>] </span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>shrink<span class="op">-</span>factors <span class="dv">8</span><span class="er">x4x2x1</span> </span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>metric MI[<span class="op">%</span>s, <span class="op">%</span>s, <span class="dv">1</span>, <span class="dv">32</span>, Regular, <span class="fl">0.25</span>] </span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>convergence [<span class="dv">1000</span><span class="er">x500x250x100</span>,<span class="fl">1e-6</span>,<span class="dv">10</span>] </span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>shrink<span class="op">-</span>factors <span class="dv">8</span><span class="er">x4x2x1</span> </span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>smoothing<span class="op">-</span>sigmas <span class="dv">3</span><span class="er">x2x1x0vox</span> </span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>transform Rigid[<span class="fl">0.1</span>] </span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>metric MI[<span class="op">%</span>s,<span class="op">%</span>s,<span class="dv">1</span>,<span class="dv">32</span>,Regular,<span class="fl">0.25</span>] </span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>convergence [<span class="dv">1000</span><span class="er">x500x250x100</span>,<span class="fl">1e-6</span>,<span class="dv">10</span>] </span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>smoothing<span class="op">-</span>sigmas <span class="dv">3</span><span class="er">x2x1x0vox</span><span class="st">" % (header_t1, xfm_filename_t1, subj_postop, subj_t1, subj_postop, subj_t1, subj_postop, subj_t1)</span></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a><span class="er">        if os.path.exists</span>(xfm_filename_t1):</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'t1 already merged to postop'</span>)</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> os.path.exists(xfm_filename_t1):</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>            os.system(command_t1)</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PRE-OP fGATIR -&gt; POST-OP T2</span></span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------- </span></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>    subj_fgatir <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">'preop/fGATIR.nii.gz'</span>) <span class="op">%</span>dpSub[i]</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(subj_fgatir):</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'NO fGATIR AVAILABLE TO MERGE'</span>)</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(subj_fgatir):</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>        header_fgatir <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">"preop/ANTS_09c/fgatir_to_postop_"</span>) <span class="op">%</span>dpSub[i]</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>        xfm_filename_fgatir <span class="op">=</span> header_fgatir <span class="op">+</span> <span class="st">"Warped.nii.gz"</span></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>        command_fgatir <span class="op">=</span> <span class="st">"antsRegistration </span></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a><span class="er">        --dimensionality 3 </span></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span><span class="bu">float</span> <span class="dv">0</span> </span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>output [<span class="op">%</span>s, <span class="op">%</span>s] </span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>interpolation NearestNeighbor </span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>winsorize<span class="op">-</span>image<span class="op">-</span>intensities [<span class="fl">0.005</span>, <span class="fl">0.995</span>] </span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>use<span class="op">-</span>histogram<span class="op">-</span>matching <span class="dv">0</span> </span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>initial<span class="op">-</span>moving<span class="op">-</span>transform [<span class="op">%</span>s, <span class="op">%</span>s,<span class="dv">1</span>] </span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>transform Rigid[<span class="fl">0.1</span>] </span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>shrink<span class="op">-</span>factors <span class="dv">8</span><span class="er">x4x2x1</span> </span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>metric MI[<span class="op">%</span>s, <span class="op">%</span>s, <span class="dv">1</span>, <span class="dv">32</span>, Regular, <span class="fl">0.25</span>] </span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>convergence [<span class="dv">1000</span><span class="er">x500x250x100</span>,<span class="fl">1e-6</span>,<span class="dv">10</span>] </span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>shrink<span class="op">-</span>factors <span class="dv">8</span><span class="er">x4x2x1</span> </span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>smoothing<span class="op">-</span>sigmas <span class="dv">3</span><span class="er">x2x1x0vox</span> </span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>transform Rigid[<span class="fl">0.1</span>] </span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>metric MI[<span class="op">%</span>s,<span class="op">%</span>s,<span class="dv">1</span>,<span class="dv">32</span>,Regular,<span class="fl">0.25</span>] </span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>convergence [<span class="dv">1000</span><span class="er">x500x250x100</span>,<span class="fl">1e-6</span>,<span class="dv">10</span>] </span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>smoothing<span class="op">-</span>sigmas <span class="dv">3</span><span class="er">x2x1x0vox</span><span class="st">" % (header_fgatir, xfm_filename_fgatir, subj_postop, subj_fgatir, subj_postop, subj_fgatir, subj_postop, subj_fgatir)</span></span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a><span class="er">        if os.path.exists</span>(xfm_filename_fgatir):</span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'fGATIR already merged to postop'</span>)</span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> os.path.exists(xfm_filename_fgatir):</span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a>            os.system(command_fgatir)</span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------</span></span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># POST-OP fGATIR -&gt; POST-OP T2</span></span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------            </span></span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>    subj_postop_fgatir <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">'immPost/fGATIR.nii.gz'</span>) <span class="op">%</span>dpSub[i]</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(subj_fgatir):</span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'NO postop_fGATIR AVAILABLE TO MERGE'</span>)</span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(subj_postop_fgatir):</span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>        header_postop_fgatir <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">"preop/ANTS_09c/postop_fgatir_to_postop_"</span>) <span class="op">%</span>dpSub[i]</span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>        xfm_filename_postop_fgatir <span class="op">=</span> header_postop_fgatir <span class="op">+</span> <span class="st">"Warped.nii.gz"</span></span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>        command_postop_fgatir <span class="op">=</span> <span class="st">"antsRegistration </span></span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a><span class="er">        --dimensionality 3 </span></span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span><span class="bu">float</span> <span class="dv">0</span> </span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>output [<span class="op">%</span>s, <span class="op">%</span>s] </span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>interpolation NearestNeighbor </span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>winsorize<span class="op">-</span>image<span class="op">-</span>intensities [<span class="fl">0.005</span>, <span class="fl">0.995</span>] </span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>use<span class="op">-</span>histogram<span class="op">-</span>matching <span class="dv">0</span> </span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>initial<span class="op">-</span>moving<span class="op">-</span>transform [<span class="op">%</span>s, <span class="op">%</span>s,<span class="dv">1</span>] </span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>transform Rigid[<span class="fl">0.1</span>] </span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>shrink<span class="op">-</span>factors <span class="dv">8</span><span class="er">x4x2x1</span> </span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>metric MI[<span class="op">%</span>s, <span class="op">%</span>s, <span class="dv">1</span>, <span class="dv">32</span>, Regular, <span class="fl">0.25</span>] </span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>convergence [<span class="dv">1000</span><span class="er">x500x250x100</span>,<span class="fl">1e-6</span>,<span class="dv">10</span>] </span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>shrink<span class="op">-</span>factors <span class="dv">8</span><span class="er">x4x2x1</span> </span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>smoothing<span class="op">-</span>sigmas <span class="dv">3</span><span class="er">x2x1x0vox</span> </span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>transform Rigid[<span class="fl">0.1</span>] </span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>metric MI[<span class="op">%</span>s,<span class="op">%</span>s,<span class="dv">1</span>,<span class="dv">32</span>,Regular,<span class="fl">0.25</span>] </span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>convergence [<span class="dv">1000</span><span class="er">x500x250x100</span>,<span class="fl">1e-6</span>,<span class="dv">10</span>] </span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>smoothing<span class="op">-</span>sigmas <span class="dv">3</span><span class="er">x2x1x0vox</span><span class="st">" % (header_postop_fgatir, xfm_filename_postop_fgatir, subj_postop, subj_postop_fgatir, subj_postop, subj_postop_fgatir, subj_postop, subj_postop_fgatir)</span></span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a><span class="er">        if os.path.exists</span>(xfm_filename_postop_fgatir):</span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'postop_fGATIR already merged to postop'</span>)</span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> os.path.exists(xfm_filename_postop_fgatir):</span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a>            os.system(command_postop_fgatir)</span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------</span></span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a>    <span class="co"># INTRA-OP T2_1 -&gt; POST-OP T2</span></span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------- </span></span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a>    subj_intraop_T2_1 <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">'immPost/intraop_T2_1.nii.gz'</span>) <span class="op">%</span>dpSub[i]</span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(subj_fgatir):</span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'NO intraop_T2_1 AVAILABLE TO MERGE'</span>)</span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(subj_intraop_T2_1):</span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a>        header_intraop_T2_1 <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">"preop/ANTS_09c/intraop_T2_1_to_postop_"</span>) <span class="op">%</span>dpSub[i]</span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a>        xfm_filename_intraop_T2_1 <span class="op">=</span> header_intraop_T2_1 <span class="op">+</span> <span class="st">"Warped.nii.gz"</span></span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a>        command_intraop_T2_1 <span class="op">=</span> <span class="st">"antsRegistration </span></span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a><span class="er">        --dimensionality 3 </span></span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span><span class="bu">float</span> <span class="dv">0</span> </span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>output [<span class="op">%</span>s, <span class="op">%</span>s] </span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>interpolation NearestNeighbor </span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>winsorize<span class="op">-</span>image<span class="op">-</span>intensities [<span class="fl">0.005</span>, <span class="fl">0.995</span>] </span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>use<span class="op">-</span>histogram<span class="op">-</span>matching <span class="dv">0</span> </span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>initial<span class="op">-</span>moving<span class="op">-</span>transform [<span class="op">%</span>s, <span class="op">%</span>s,<span class="dv">1</span>] </span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>transform Rigid[<span class="fl">0.1</span>] </span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>shrink<span class="op">-</span>factors <span class="dv">8</span><span class="er">x4x2x1</span> </span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>metric MI[<span class="op">%</span>s, <span class="op">%</span>s, <span class="dv">1</span>, <span class="dv">32</span>, Regular, <span class="fl">0.25</span>] </span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>convergence [<span class="dv">1000</span><span class="er">x500x250x100</span>,<span class="fl">1e-6</span>,<span class="dv">10</span>] </span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>shrink<span class="op">-</span>factors <span class="dv">8</span><span class="er">x4x2x1</span> </span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>smoothing<span class="op">-</span>sigmas <span class="dv">3</span><span class="er">x2x1x0vox</span> </span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>transform Rigid[<span class="fl">0.1</span>] </span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>metric MI[<span class="op">%</span>s,<span class="op">%</span>s,<span class="dv">1</span>,<span class="dv">32</span>,Regular,<span class="fl">0.25</span>] </span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>convergence [<span class="dv">1000</span><span class="er">x500x250x100</span>,<span class="fl">1e-6</span>,<span class="dv">10</span>] </span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>smoothing<span class="op">-</span>sigmas <span class="dv">3</span><span class="er">x2x1x0vox</span><span class="st">" % (header_intraop_T2_1, xfm_filename_intraop_T2_1, subj_postop, subj_intraop_T2_1, subj_postop, subj_intraop_T2_1, subj_postop, subj_intraop_T2_1)</span></span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true" tabindex="-1"></a><span class="er">        if os.path.exists</span>(xfm_filename_intraop_T2_1):</span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'intraop_T2_1 already merged to postop'</span>)</span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> os.path.exists(xfm_filename_intraop_T2_1):</span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true" tabindex="-1"></a>            os.system(command_intraop_T2_1)</span>
<span id="cb1-199"><a href="#cb1-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-200"><a href="#cb1-200" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------</span></span>
<span id="cb1-201"><a href="#cb1-201" aria-hidden="true" tabindex="-1"></a>    <span class="co"># INTRA-OP T2_2 -&gt; POST-OP T2</span></span>
<span id="cb1-202"><a href="#cb1-202" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------</span></span>
<span id="cb1-203"><a href="#cb1-203" aria-hidden="true" tabindex="-1"></a>    <span class="co"># only if a second intra-op scan was performed, typically not</span></span>
<span id="cb1-204"><a href="#cb1-204" aria-hidden="true" tabindex="-1"></a>    subj_intraop_T2_2 <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">'immPost/intraop_T2_2.nii.gz'</span>) <span class="op">%</span>dpSub[i]</span>
<span id="cb1-205"><a href="#cb1-205" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(subj_fgatir):</span>
<span id="cb1-206"><a href="#cb1-206" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'NO intraop_T2_2 AVAILABLE TO MERGE'</span>)</span>
<span id="cb1-207"><a href="#cb1-207" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(subj_intraop_T2_2):</span>
<span id="cb1-208"><a href="#cb1-208" aria-hidden="true" tabindex="-1"></a>        header_intraop_T2_2 <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">"preop/ANTS_09c/intraop_T2_2_to_postop_"</span>) <span class="op">%</span>dpSub[i]</span>
<span id="cb1-209"><a href="#cb1-209" aria-hidden="true" tabindex="-1"></a>        xfm_filename_intraop_T2_2 <span class="op">=</span> header_intraop_T2_2 <span class="op">+</span> <span class="st">"Warped.nii.gz"</span></span>
<span id="cb1-210"><a href="#cb1-210" aria-hidden="true" tabindex="-1"></a>        command_intraop_T2_2 <span class="op">=</span> <span class="st">"antsRegistration </span></span>
<span id="cb1-211"><a href="#cb1-211" aria-hidden="true" tabindex="-1"></a><span class="er">        --dimensionality 3 </span></span>
<span id="cb1-212"><a href="#cb1-212" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span><span class="bu">float</span> <span class="dv">0</span> </span>
<span id="cb1-213"><a href="#cb1-213" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>output [<span class="op">%</span>s, <span class="op">%</span>s] </span>
<span id="cb1-214"><a href="#cb1-214" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>interpolation NearestNeighbor </span>
<span id="cb1-215"><a href="#cb1-215" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>winsorize<span class="op">-</span>image<span class="op">-</span>intensities [<span class="fl">0.005</span>, <span class="fl">0.995</span>]         </span>
<span id="cb1-216"><a href="#cb1-216" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>use<span class="op">-</span>histogram<span class="op">-</span>matching <span class="dv">0</span> </span>
<span id="cb1-217"><a href="#cb1-217" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>initial<span class="op">-</span>moving<span class="op">-</span>transform [<span class="op">%</span>s, <span class="op">%</span>s,<span class="dv">1</span>] </span>
<span id="cb1-218"><a href="#cb1-218" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>transform Rigid[<span class="fl">0.1</span>] </span>
<span id="cb1-219"><a href="#cb1-219" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>shrink<span class="op">-</span>factors <span class="dv">8</span><span class="er">x4x2x1</span> </span>
<span id="cb1-220"><a href="#cb1-220" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>metric MI[<span class="op">%</span>s, <span class="op">%</span>s, <span class="dv">1</span>, <span class="dv">32</span>, Regular, <span class="fl">0.25</span>] </span>
<span id="cb1-221"><a href="#cb1-221" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>convergence [<span class="dv">1000</span><span class="er">x500x250x100</span>,<span class="fl">1e-6</span>,<span class="dv">10</span>]</span>
<span id="cb1-222"><a href="#cb1-222" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>shrink<span class="op">-</span>factors <span class="dv">8</span><span class="er">x4x2x1</span> </span>
<span id="cb1-223"><a href="#cb1-223" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>smoothing<span class="op">-</span>sigmas <span class="dv">3</span><span class="er">x2x1x0vox</span> </span>
<span id="cb1-224"><a href="#cb1-224" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>transform Rigid[<span class="fl">0.1</span>] </span>
<span id="cb1-225"><a href="#cb1-225" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>metric MI[<span class="op">%</span>s,<span class="op">%</span>s,<span class="dv">1</span>,<span class="dv">32</span>,Regular,<span class="fl">0.25</span>] </span>
<span id="cb1-226"><a href="#cb1-226" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>convergence [<span class="dv">1000</span><span class="er">x500x250x100</span>,<span class="fl">1e-6</span>,<span class="dv">10</span>] </span>
<span id="cb1-227"><a href="#cb1-227" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>smoothing<span class="op">-</span>sigmas <span class="dv">3</span><span class="er">x2x1x0vox</span><span class="st">" % (header_intraop_T2_2, xfm_filename_intraop_T2_2, subj_postop, subj_intraop_T2_2, subj_postop, subj_intraop_T2_2, subj_postop, subj_intraop_T2_2)</span></span>
<span id="cb1-228"><a href="#cb1-228" aria-hidden="true" tabindex="-1"></a><span class="er">        if os.path.exists</span>(xfm_filename_intraop_T2_2):</span>
<span id="cb1-229"><a href="#cb1-229" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'intraop_T2_2 already merged to postop'</span>)</span>
<span id="cb1-230"><a href="#cb1-230" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> os.path.exists(xfm_filename_intraop_T2_2):</span>
<span id="cb1-231"><a href="#cb1-231" aria-hidden="true" tabindex="-1"></a>            os.system(command_intraop_T2_2)</span>
<span id="cb1-232"><a href="#cb1-232" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-233"><a href="#cb1-233" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------</span></span>
<span id="cb1-234"><a href="#cb1-234" aria-hidden="true" tabindex="-1"></a>    <span class="co"># INTR-OP T2_3 → POST-OP T2</span></span>
<span id="cb1-235"><a href="#cb1-235" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------</span></span>
<span id="cb1-236"><a href="#cb1-236" aria-hidden="true" tabindex="-1"></a>    <span class="co"># only if a third intra-op scan was performed, typically not</span></span>
<span id="cb1-237"><a href="#cb1-237" aria-hidden="true" tabindex="-1"></a>    subj_intraop_T2_3 <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">'immPost/intraop_T2_3.nii.gz'</span>) <span class="op">%</span>dpSub[i]</span>
<span id="cb1-238"><a href="#cb1-238" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(subj_fgatir):</span>
<span id="cb1-239"><a href="#cb1-239" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'NO intraop_T2_3 AVAILABLE TO MERGE'</span>)</span>
<span id="cb1-240"><a href="#cb1-240" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(subj_intraop_T2_3):</span>
<span id="cb1-241"><a href="#cb1-241" aria-hidden="true" tabindex="-1"></a>        header_intraop_T2_3 <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">"preop/ANTS_09c/intraop_T2_3_to_postop_"</span>) <span class="op">%</span>dpSub[i]</span>
<span id="cb1-242"><a href="#cb1-242" aria-hidden="true" tabindex="-1"></a>        xfm_filename_intraop_T2_3 <span class="op">=</span> header_intraop_T2_3 <span class="op">+</span> <span class="st">"Warped.nii.gz"</span></span>
<span id="cb1-243"><a href="#cb1-243" aria-hidden="true" tabindex="-1"></a>        command_intraop_T2_3 <span class="op">=</span> <span class="st">"antsRegistration </span></span>
<span id="cb1-244"><a href="#cb1-244" aria-hidden="true" tabindex="-1"></a><span class="er">        --dimensionality 3 </span></span>
<span id="cb1-245"><a href="#cb1-245" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span><span class="bu">float</span> <span class="dv">0</span> </span>
<span id="cb1-246"><a href="#cb1-246" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>output [<span class="op">%</span>s, <span class="op">%</span>s] </span>
<span id="cb1-247"><a href="#cb1-247" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>interpolation NearestNeighbor </span>
<span id="cb1-248"><a href="#cb1-248" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>winsorize<span class="op">-</span>image<span class="op">-</span>intensities [<span class="fl">0.005</span>, <span class="fl">0.995</span>] </span>
<span id="cb1-249"><a href="#cb1-249" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>use<span class="op">-</span>histogram<span class="op">-</span>matching <span class="dv">0</span> </span>
<span id="cb1-250"><a href="#cb1-250" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>initial<span class="op">-</span>moving<span class="op">-</span>transform [<span class="op">%</span>s, <span class="op">%</span>s,<span class="dv">1</span>] </span>
<span id="cb1-251"><a href="#cb1-251" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>transform Rigid[<span class="fl">0.1</span>] </span>
<span id="cb1-252"><a href="#cb1-252" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>shrink<span class="op">-</span>factors <span class="dv">8</span><span class="er">x4x2x1</span> </span>
<span id="cb1-253"><a href="#cb1-253" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>metric MI[<span class="op">%</span>s, <span class="op">%</span>s, <span class="dv">1</span>, <span class="dv">32</span>, Regular, <span class="fl">0.25</span>] </span>
<span id="cb1-254"><a href="#cb1-254" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>convergence [<span class="dv">1000</span><span class="er">x500x250x100</span>,<span class="fl">1e-6</span>,<span class="dv">10</span>] </span>
<span id="cb1-255"><a href="#cb1-255" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>shrink<span class="op">-</span>factors <span class="dv">8</span><span class="er">x4x2x1</span> </span>
<span id="cb1-256"><a href="#cb1-256" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>smoothing<span class="op">-</span>sigmas <span class="dv">3</span><span class="er">x2x1x0vox</span> </span>
<span id="cb1-257"><a href="#cb1-257" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>transform Rigid[<span class="fl">0.1</span>] </span>
<span id="cb1-258"><a href="#cb1-258" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>metric MI[<span class="op">%</span>s,<span class="op">%</span>s,<span class="dv">1</span>,<span class="dv">32</span>,Regular,<span class="fl">0.25</span>] </span>
<span id="cb1-259"><a href="#cb1-259" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>convergence [<span class="dv">1000</span><span class="er">x500x250x100</span>,<span class="fl">1e-6</span>,<span class="dv">10</span>] </span>
<span id="cb1-260"><a href="#cb1-260" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>smoothing<span class="op">-</span>sigmas <span class="dv">3</span><span class="er">x2x1x0vox</span><span class="st">" % (header_intraop_T2_3, xfm_filename_intraop_T2_3, subj_postop, subj_intraop_T2_3, subj_postop, subj_intraop_T2_3, subj_postop, subj_intraop_T2_3)</span></span>
<span id="cb1-261"><a href="#cb1-261" aria-hidden="true" tabindex="-1"></a><span class="er">        if os.path.exists</span>(xfm_filename_intraop_T2_3):</span>
<span id="cb1-262"><a href="#cb1-262" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'intraop_T2_3 already merged to postop'</span>)</span>
<span id="cb1-263"><a href="#cb1-263" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> os.path.exists(xfm_filename_intraop_T2_3):</span>
<span id="cb1-264"><a href="#cb1-264" aria-hidden="true" tabindex="-1"></a>            os.system(command_intraop_T2_3)    </span>
<span id="cb1-265"><a href="#cb1-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-266"><a href="#cb1-266" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------</span></span>
<span id="cb1-267"><a href="#cb1-267" aria-hidden="true" tabindex="-1"></a>    <span class="co"># INTRA-OP T2_4 -&gt; POST-OP T2</span></span>
<span id="cb1-268"><a href="#cb1-268" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------</span></span>
<span id="cb1-269"><a href="#cb1-269" aria-hidden="true" tabindex="-1"></a>    <span class="co"># only if a fourth intra-op scan was performed, typically not</span></span>
<span id="cb1-270"><a href="#cb1-270" aria-hidden="true" tabindex="-1"></a>    subj_intraop_T2_4 <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">'immPost/intraop_T2_4.nii.gz'</span>) <span class="op">%</span>dpSub[i]</span>
<span id="cb1-271"><a href="#cb1-271" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(subj_fgatir):</span>
<span id="cb1-272"><a href="#cb1-272" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'NO intraop_T2_4 AVAILABLE TO MERGE'</span>)</span>
<span id="cb1-273"><a href="#cb1-273" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(subj_intraop_T2_4):</span>
<span id="cb1-274"><a href="#cb1-274" aria-hidden="true" tabindex="-1"></a>        header_intraop_T2_4 <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">"preop/ANTS_09c/intraop_T2_4_to_postop_"</span>) <span class="op">%</span>dpSub[i]</span>
<span id="cb1-275"><a href="#cb1-275" aria-hidden="true" tabindex="-1"></a>        xfm_filename_intraop_T2_4 <span class="op">=</span> header_intraop_T2_4 <span class="op">+</span> <span class="st">"Warped.nii.gz"</span></span>
<span id="cb1-276"><a href="#cb1-276" aria-hidden="true" tabindex="-1"></a>        command_intraop_T2_4 <span class="op">=</span> <span class="st">"antsRegistration </span></span>
<span id="cb1-277"><a href="#cb1-277" aria-hidden="true" tabindex="-1"></a><span class="er">        --dimensionality 3 </span></span>
<span id="cb1-278"><a href="#cb1-278" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span><span class="bu">float</span> <span class="dv">0</span> </span>
<span id="cb1-279"><a href="#cb1-279" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>output [<span class="op">%</span>s, <span class="op">%</span>s] </span>
<span id="cb1-280"><a href="#cb1-280" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>interpolation NearestNeighbor </span>
<span id="cb1-281"><a href="#cb1-281" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>winsorize<span class="op">-</span>image<span class="op">-</span>intensities [<span class="fl">0.005</span>, <span class="fl">0.995</span>] </span>
<span id="cb1-282"><a href="#cb1-282" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>use<span class="op">-</span>histogram<span class="op">-</span>matching <span class="dv">0</span> </span>
<span id="cb1-283"><a href="#cb1-283" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>initial<span class="op">-</span>moving<span class="op">-</span>transform [<span class="op">%</span>s, <span class="op">%</span>s,<span class="dv">1</span>] </span>
<span id="cb1-284"><a href="#cb1-284" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>transform Rigid[<span class="fl">0.1</span>] </span>
<span id="cb1-285"><a href="#cb1-285" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>shrink<span class="op">-</span>factors <span class="dv">8</span><span class="er">x4x2x1</span> </span>
<span id="cb1-286"><a href="#cb1-286" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>metric MI[<span class="op">%</span>s, <span class="op">%</span>s, <span class="dv">1</span>, <span class="dv">32</span>, Regular, <span class="fl">0.25</span>] </span>
<span id="cb1-287"><a href="#cb1-287" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>convergence [<span class="dv">1000</span><span class="er">x500x250x100</span>,<span class="fl">1e-6</span>,<span class="dv">10</span>] </span>
<span id="cb1-288"><a href="#cb1-288" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>shrink<span class="op">-</span>factors <span class="dv">8</span><span class="er">x4x2x1</span> </span>
<span id="cb1-289"><a href="#cb1-289" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>smoothing<span class="op">-</span>sigmas <span class="dv">3</span><span class="er">x2x1x0vox</span> </span>
<span id="cb1-290"><a href="#cb1-290" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>transform Rigid[<span class="fl">0.1</span>] </span>
<span id="cb1-291"><a href="#cb1-291" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>metric MI[<span class="op">%</span>s,<span class="op">%</span>s,<span class="dv">1</span>,<span class="dv">32</span>,Regular,<span class="fl">0.25</span>] </span>
<span id="cb1-292"><a href="#cb1-292" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>convergence [<span class="dv">1000</span><span class="er">x500x250x100</span>,<span class="fl">1e-6</span>,<span class="dv">10</span>] </span>
<span id="cb1-293"><a href="#cb1-293" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>smoothing<span class="op">-</span>sigmas <span class="dv">3</span><span class="er">x2x1x0vox</span><span class="st">" % (header_intraop_T2_4, xfm_filename_intraop_T2_4, subj_postop, subj_intraop_T2_4, subj_postop, subj_intraop_T2_4, subj_postop, subj_intraop_T2_4)</span></span>
<span id="cb1-294"><a href="#cb1-294" aria-hidden="true" tabindex="-1"></a><span class="er">        if os.path.exists</span>(xfm_filename_intraop_T2_4):</span>
<span id="cb1-295"><a href="#cb1-295" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'intraop_T2_4 already merged to postop'</span>)</span>
<span id="cb1-296"><a href="#cb1-296" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> os.path.exists(xfm_filename_intraop_T2_4):</span>
<span id="cb1-297"><a href="#cb1-297" aria-hidden="true" tabindex="-1"></a>            os.system(command_intraop_T2_4)                   </span>
<span id="cb1-298"><a href="#cb1-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-299"><a href="#cb1-299" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------</span></span>
<span id="cb1-300"><a href="#cb1-300" aria-hidden="true" tabindex="-1"></a>    <span class="co"># POST-OP T1 -&gt; POST-OP T2</span></span>
<span id="cb1-301"><a href="#cb1-301" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------</span></span>
<span id="cb1-302"><a href="#cb1-302" aria-hidden="true" tabindex="-1"></a>    subj_postop_t1 <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">'immPost/t1.nii.gz'</span>) <span class="op">%</span>dpSub[i]</span>
<span id="cb1-303"><a href="#cb1-303" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(subj_fgatir):</span>
<span id="cb1-304"><a href="#cb1-304" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'NO postop_t1 AVAILABLE TO MERGE'</span>)</span>
<span id="cb1-305"><a href="#cb1-305" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(subj_postop_t1):</span>
<span id="cb1-306"><a href="#cb1-306" aria-hidden="true" tabindex="-1"></a>        header_postop_t1 <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">"preop/ANTS_09c/postop_t1_to_postop_"</span>) <span class="op">%</span>dpSub[i]</span>
<span id="cb1-307"><a href="#cb1-307" aria-hidden="true" tabindex="-1"></a>        xfm_filename_postop_t1 <span class="op">=</span> header_postop_t1 <span class="op">+</span> <span class="st">"Warped.nii.gz"</span></span>
<span id="cb1-308"><a href="#cb1-308" aria-hidden="true" tabindex="-1"></a>        command_postop_t1 <span class="op">=</span> <span class="st">"antsRegistration </span></span>
<span id="cb1-309"><a href="#cb1-309" aria-hidden="true" tabindex="-1"></a><span class="er">        --dimensionality 3 </span></span>
<span id="cb1-310"><a href="#cb1-310" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span><span class="bu">float</span> <span class="dv">0</span> </span>
<span id="cb1-311"><a href="#cb1-311" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>output [<span class="op">%</span>s, <span class="op">%</span>s] </span>
<span id="cb1-312"><a href="#cb1-312" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>interpolation NearestNeighbor </span>
<span id="cb1-313"><a href="#cb1-313" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>winsorize<span class="op">-</span>image<span class="op">-</span>intensities [<span class="fl">0.005</span>, <span class="fl">0.995</span>] </span>
<span id="cb1-314"><a href="#cb1-314" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>use<span class="op">-</span>histogram<span class="op">-</span>matching <span class="dv">0</span> </span>
<span id="cb1-315"><a href="#cb1-315" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>initial<span class="op">-</span>moving<span class="op">-</span>transform [<span class="op">%</span>s, <span class="op">%</span>s,<span class="dv">1</span>] </span>
<span id="cb1-316"><a href="#cb1-316" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>transform Rigid[<span class="fl">0.1</span>] </span>
<span id="cb1-317"><a href="#cb1-317" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>shrink<span class="op">-</span>factors <span class="dv">8</span><span class="er">x4x2x1</span> </span>
<span id="cb1-318"><a href="#cb1-318" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>metric MI[<span class="op">%</span>s, <span class="op">%</span>s, <span class="dv">1</span>, <span class="dv">32</span>, Regular, <span class="fl">0.25</span>] </span>
<span id="cb1-319"><a href="#cb1-319" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>convergence [<span class="dv">1000</span><span class="er">x500x250x100</span>,<span class="fl">1e-6</span>,<span class="dv">10</span>] </span>
<span id="cb1-320"><a href="#cb1-320" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>shrink<span class="op">-</span>factors <span class="dv">8</span><span class="er">x4x2x1</span> </span>
<span id="cb1-321"><a href="#cb1-321" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>smoothing<span class="op">-</span>sigmas <span class="dv">3</span><span class="er">x2x1x0vox</span> </span>
<span id="cb1-322"><a href="#cb1-322" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>transform Rigid[<span class="fl">0.1</span>] </span>
<span id="cb1-323"><a href="#cb1-323" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>metric MI[<span class="op">%</span>s,<span class="op">%</span>s,<span class="dv">1</span>,<span class="dv">32</span>,Regular,<span class="fl">0.25</span>] </span>
<span id="cb1-324"><a href="#cb1-324" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>convergence [<span class="dv">1000</span><span class="er">x500x250x100</span>,<span class="fl">1e-6</span>,<span class="dv">10</span>] </span>
<span id="cb1-325"><a href="#cb1-325" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>smoothing<span class="op">-</span>sigmas <span class="dv">3</span><span class="er">x2x1x0vox</span><span class="st">" % (header_postop_t1, xfm_filename_postop_t1, subj_postop, subj_postop_t1, subj_postop, subj_postop_t1, subj_postop, subj_postop_t1)</span></span>
<span id="cb1-326"><a href="#cb1-326" aria-hidden="true" tabindex="-1"></a><span class="er">        if os.path.exists</span>(xfm_filename_postop_t1):</span>
<span id="cb1-327"><a href="#cb1-327" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'postop_t1 already merged to postop'</span>)</span>
<span id="cb1-328"><a href="#cb1-328" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> os.path.exists(xfm_filename_postop_t1):</span>
<span id="cb1-329"><a href="#cb1-329" aria-hidden="true" tabindex="-1"></a>            os.system(command_postop_t1)</span>
<span id="cb1-330"><a href="#cb1-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-331"><a href="#cb1-331" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------</span></span>
<span id="cb1-332"><a href="#cb1-332" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PRE-OP CT -&gt; POST-OP T2</span></span>
<span id="cb1-333"><a href="#cb1-333" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------</span></span>
<span id="cb1-334"><a href="#cb1-334" aria-hidden="true" tabindex="-1"></a>    <span class="co"># only if pre-op CT available</span></span>
<span id="cb1-335"><a href="#cb1-335" aria-hidden="true" tabindex="-1"></a>    subj_ct <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">'preop/ct.nii.gz'</span>) <span class="op">%</span>dpSub[i]</span>
<span id="cb1-336"><a href="#cb1-336" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(RegDir)</span>
<span id="cb1-337"><a href="#cb1-337" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(subj_ct):</span>
<span id="cb1-338"><a href="#cb1-338" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'NO POSTOP CT AVAILABLE TO MERGE'</span>)</span>
<span id="cb1-339"><a href="#cb1-339" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(subj_ct):</span>
<span id="cb1-340"><a href="#cb1-340" aria-hidden="true" tabindex="-1"></a>        header_ct <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">"ANTS_09c/preop_ct_to_postop_"</span>) <span class="op">%</span>dpSub[i]</span>
<span id="cb1-341"><a href="#cb1-341" aria-hidden="true" tabindex="-1"></a>        xfm_filename_ct <span class="op">=</span> header_ct <span class="op">+</span> <span class="st">"Warped.nii.gz"</span></span>
<span id="cb1-342"><a href="#cb1-342" aria-hidden="true" tabindex="-1"></a>        command_ct <span class="op">=</span> <span class="st">"antsRegistration </span></span>
<span id="cb1-343"><a href="#cb1-343" aria-hidden="true" tabindex="-1"></a><span class="er">        --dimensionality 3 </span></span>
<span id="cb1-344"><a href="#cb1-344" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span><span class="bu">float</span> <span class="dv">0</span> </span>
<span id="cb1-345"><a href="#cb1-345" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>output [<span class="op">%</span>s, <span class="op">%</span>s] </span>
<span id="cb1-346"><a href="#cb1-346" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>interpolation NearestNeighbor </span>
<span id="cb1-347"><a href="#cb1-347" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>winsorize<span class="op">-</span>image<span class="op">-</span>intensities [<span class="fl">0.005</span>, <span class="fl">0.995</span>] </span>
<span id="cb1-348"><a href="#cb1-348" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>use<span class="op">-</span>histogram<span class="op">-</span>matching <span class="dv">0</span> </span>
<span id="cb1-349"><a href="#cb1-349" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>initial<span class="op">-</span>moving<span class="op">-</span>transform [<span class="op">%</span>s, <span class="op">%</span>s,<span class="dv">1</span>] </span>
<span id="cb1-350"><a href="#cb1-350" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>transform Rigid[<span class="fl">0.1</span>] </span>
<span id="cb1-351"><a href="#cb1-351" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>shrink<span class="op">-</span>factors <span class="dv">8</span><span class="er">x4x2x1</span> </span>
<span id="cb1-352"><a href="#cb1-352" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>metric MI[<span class="op">%</span>s, <span class="op">%</span>s, <span class="dv">1</span>, <span class="dv">32</span>, Regular, <span class="fl">0.25</span>] </span>
<span id="cb1-353"><a href="#cb1-353" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>convergence [<span class="dv">1000</span><span class="er">x500x250x100</span>,<span class="fl">1e-6</span>,<span class="dv">10</span>] </span>
<span id="cb1-354"><a href="#cb1-354" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>shrink<span class="op">-</span>factors <span class="dv">8</span><span class="er">x4x2x1</span> </span>
<span id="cb1-355"><a href="#cb1-355" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>smoothing<span class="op">-</span>sigmas <span class="dv">3</span><span class="er">x2x1x0vox</span> </span>
<span id="cb1-356"><a href="#cb1-356" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>transform Rigid[<span class="fl">0.1</span>] </span>
<span id="cb1-357"><a href="#cb1-357" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>metric MI[<span class="op">%</span>s,<span class="op">%</span>s,<span class="dv">1</span>,<span class="dv">32</span>,Regular,<span class="fl">0.25</span>] </span>
<span id="cb1-358"><a href="#cb1-358" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>convergence [<span class="dv">1000</span><span class="er">x500x250x100</span>,<span class="fl">1e-6</span>,<span class="dv">10</span>] </span>
<span id="cb1-359"><a href="#cb1-359" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>smoothing<span class="op">-</span>sigmas <span class="dv">3</span><span class="er">x2x1x0vox</span><span class="st">" % (header_ct, xfm_filename_ct, subj_postop, subj_ct, subj_postop, subj_ct, subj_postop, subj_ct)</span></span>
<span id="cb1-360"><a href="#cb1-360" aria-hidden="true" tabindex="-1"></a><span class="er">        if os.path.exists</span>(xfm_filename_ct):</span>
<span id="cb1-361"><a href="#cb1-361" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'preop CT already merged to postop T2'</span>)</span>
<span id="cb1-362"><a href="#cb1-362" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> os.path.exists(xfm_filename_ct):</span>
<span id="cb1-363"><a href="#cb1-363" aria-hidden="true" tabindex="-1"></a>            os.system(command_ct) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once a subject’s available imaging is fully aligned, ablation lesions were segmented on post-operative MRI using ITK-SnAP. Hyperintense or hypointense signal changes consistent with thermal ablation were traced slice-by-slice using the random forest-based ‘snake evolution’ algorithm auto-segmentation tool to produce a binary lesion mask for each subject. This process is outlined below.</p>
<div class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/BR-11132025-screenshots/lesion-masking.png" class="img-fluid figure-img" style="width:70.0%"></p>
<figcaption>Once a lesion is identified, ITK-SnAP is used to paint zone 1 of the lesion red: the true lesion (white in the scan) that is necrotic after the procedure.</figcaption>
</figure>
</div>
</div>
<div class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/BR-11132025-screenshots/lesion-masking-2.png" class="img-fluid figure-img" style="width:70.0%"></p>
<figcaption>Zone 2 of the lesion is then painted green; this is the rim of the true lesion and the start of consequential edema, which should not be included in lesion volume calculations.</figcaption>
</figure>
</div>
</div>
<div class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/BR-11132025-screenshots/lesion-masking-3.png" class="img-fluid figure-img" style="width:70.0%"></p>
<figcaption>Last, zone 3 of the lesion is painted blue; this informs ITK-SnAP to exclude everything beyond the lesion.</figcaption>
</figure>
</div>
</div>
<div class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/BR-11132025-screenshots/lesion-masking-classification.png" class="img-fluid figure-img" style="width:30.0%"></p>
<figcaption>Once the classifier is trained based on the three painted zones (see right panel of previous image), we set classification features to increase precision.</figcaption>
</figure>
</div>
</div>
<div class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/BR-11132025-screenshots/lesion-masking-evolution.png" class="img-fluid figure-img" style="width:70.0%"></p>
<figcaption>Then we run the auto-segmentation tool. We let it run for at least 1000 iterations to increase precision.</figcaption>
</figure>
</div>
</div>
<div class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/BR-11132025-screenshots/lesion-masking-final.png" class="img-fluid figure-img" style="width:70.0%"></p>
<figcaption>Once completed, the lesion mask has been created. A clinician reviews the mask and is able to manually add or remove voxels from the mask using the brush tool.</figcaption>
</figure>
</div>
</div>
<p>These masks were exported in NIfTI format for volumetric processing using Python. Lesion volumes were calculated by multiplying the number of voxels in the mask by the voxel volume. The annotated Python script is shown here:</p>
<div class="cell" data-python.reticulate="false">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> nibabel <span class="im">as</span> nib</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fnmatch</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>os.system(<span class="st">"export FSLPARALLEL=slurm"</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"subject, voi, voi_voxel, voi_vol_mm3"</span>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Set directories</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>subjects_dir <span class="op">=</span> <span class="bu">list</span>(glob.glob(<span class="st">"/media/halpernlab/Expansion/Targeting_storage/FUS/subjects/preop_immPost/sub*/preop"</span>)) <span class="co">#CHANGE DIRECTORY</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span> (<span class="bu">len</span>(subjects_dir)):</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    voi_input <span class="op">=</span> sys.argv[<span class="dv">1</span>] <span class="co">#lesion</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    voi <span class="op">=</span> <span class="bu">str</span>(<span class="st">"</span><span class="sc">%s</span><span class="st">/"</span> <span class="op">+</span> <span class="st">"</span><span class="sc">%s</span><span class="st">.nii.gz"</span>) <span class="op">%</span>(subjects_dir[i], voi_input)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(voi):</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        get_voi_vol_mm3 <span class="op">=</span> <span class="st">'fslstats </span><span class="sc">%s</span><span class="st"> -V'</span> <span class="op">%</span>(voi)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>        voi_voxel <span class="op">=</span> subprocess.check_output(get_voi_vol_mm3, shell<span class="op">=</span><span class="va">True</span>).decode(<span class="st">'ascii'</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>        voi_voxel <span class="op">=</span> <span class="bu">float</span>(voi_voxel[:voi_voxel.find(<span class="st">' '</span>)])</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        voi_vol_mm3 <span class="op">=</span> subprocess.check_output(get_voi_vol_mm3, shell<span class="op">=</span><span class="va">True</span>).decode(<span class="st">'ascii'</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>        voi_vol_mm3 <span class="op">=</span> <span class="bu">float</span>(voi_vol_mm3[voi_vol_mm3.find(<span class="st">' '</span>):])</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(subjects_dir[i], voi_input, voi_voxel, voi_vol_mm3, sep <span class="op">=</span><span class="st">","</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The two major components of the PTT, the ansa lenticularis and the lenticular fasciculus, were previously defined using the Dystonia Response Tract Atlas (Horn 2022). All tract masks were imported into Python and re-sampled to align with the subject’s anatomical space and lesion mask.</p>
<div class="cell" data-python.reticulate="false">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fnmatch</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># automatic subject discovery, see example:</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># subjects = list(glob.glob("/media/halpernlab/Expansion/Targeting_storage/FUS/subjects/082022/sub-ET_ET_08182022/preop"))</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># comma-separated list of subject base paths</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>subj <span class="op">=</span> sys.argv[<span class="dv">1</span>]</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>subjects <span class="op">=</span> <span class="bu">list</span>(subj.split(<span class="st">","</span>))  <span class="co"># convert to Python list of subject directories</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>dpSub <span class="op">=</span> subjects                  </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co"># comma-separated list of ROI names (no .nii.gz)</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co"># e.g. "PTT_L,PTT_R,Ansa_L"</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>rois <span class="op">=</span> sys.argv[<span class="dv">2</span>]</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>rois <span class="op">=</span> <span class="bu">list</span>(rois.split(<span class="st">","</span>))</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(rois)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(subjects)):</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># registration directory for specific to subject</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    RegDir <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">'ANTS_09c/'</span>) <span class="op">%</span> dpSub[i]</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    dpReg <span class="op">=</span> <span class="bu">str</span>(RegDir)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    mkreg_cmd <span class="op">=</span> <span class="st">'mkdir </span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> dpReg</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create ANTs registration directory if it doesn't exist</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(dpReg):</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>        os.system(mkreg_cmd)</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moving image = subject T1, here named "3d.nii.gz"</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    subj_t1w <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">'3d.nii.gz'</span>) <span class="op">%</span> dpSub[i]</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fixed image = postop scan</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    subj_postop <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">'postop.nii.gz'</span>) <span class="op">%</span> dpSub[i]</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># prefix for ANTs registration outputs</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    header <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">"ANTS_09c/postop_to_t1w_"</span>) <span class="op">%</span> dpSub[i]</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># full path to expected warped output</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    xfm_filename <span class="op">=</span> header <span class="op">+</span> <span class="st">"Warped.nii.gz"</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># antsRegistration command:</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   register postop -&gt; T1 rigidly, using mutual information</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   save transforms with prefix `header` and warped image as `xfm_filename`</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>    command <span class="op">=</span> (</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">"antsRegistration "</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--dimensionality 3 --float 0 "</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--output [</span><span class="sc">%s</span><span class="st">, </span><span class="sc">%s</span><span class="st">] "</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--interpolation NearestNeighbor "</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--winsorize-image-intensities [0.005, 0.995] "</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--use-histogram-matching 0 "</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--initial-moving-transform [</span><span class="sc">%s</span><span class="st">, </span><span class="sc">%s</span><span class="st">,1] "</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--transform Rigid[0.1] "</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--shrink-factors 8x4x2x1 "</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--metric MI[</span><span class="sc">%s</span><span class="st">, </span><span class="sc">%s</span><span class="st">, 1, 32, Regular, 0.25] "</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--convergence [1000x500x250x100,1e-6,10] "</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--shrink-factors 8x4x2x1 "</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--smoothing-sigmas 3x2x1x0vox "</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--transform Rigid[0.1] "</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--metric MI[</span><span class="sc">%s</span><span class="st">,</span><span class="sc">%s</span><span class="st">,1,32,Regular,0.25] "</span></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--convergence [1000x500x250x100,1e-6,10] "</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--smoothing-sigmas 3x2x1x0vox"</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">%</span> (header, xfm_filename,</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>         subj_t1w, subj_postop,</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>         subj_t1w, subj_postop,</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>         subj_t1w, subj_postop)</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># only run registration if:</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   registration directory exists AND</span></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   warped output does not already exist</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(dpReg) <span class="kw">and</span> <span class="kw">not</span> os.path.exists(xfm_filename):</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>        os.system(command)</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>    <span class="co">#--------------            </span></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>    ANTS <span class="dv">3</span>             </span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">#--------------</span></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># path to affine transform from antsRegistration:</span></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>    fnAff_MNIaff <span class="op">=</span> <span class="bu">str</span>(dpReg <span class="op">+</span> <span class="st">'postop_to_t1w_0GenericAffine.mat'</span>)</span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># reference image for antsApplyTransforms</span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Here: original postop image (we want ROIs in postop space)</span></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>    fnTranBrainNii <span class="op">=</span> <span class="bu">str</span>(dpSub[i] <span class="op">+</span> <span class="st">'/postop.nii.gz'</span>)</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># alternative: use warped postop in T1 space</span></span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fnTranBrainNii = str(dpReg + 'postop_to_t1w_Warped.nii.gz')</span></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># output directory for transformed ROI masks in postop space</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>    OutDir <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">'seedmasksINpostop_9b'</span>) <span class="op">%</span> dpSub[i]</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>    mk_out <span class="op">=</span> <span class="st">'mkdir </span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> OutDir</span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(OutDir):</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>        os.system(mk_out)</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># directory containing ROI masks in T1/native space</span></span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>    MasksDir <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">'seedmasks_09b_T1'</span>) <span class="op">%</span> dpSub[i]</span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>    Masks <span class="op">=</span> rois  <span class="co"># ROI *names* are passed from CLI</span></span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(Masks)):</span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>        <span class="co"># construct full path to this ROI mask in T1/native space:</span></span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>        <span class="co">#   &lt;sub&gt;/seedmasks_09b_T1/&lt;ROI&gt;.nii.gz</span></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>        fnROImask <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">/'</span> <span class="op">+</span> <span class="st">'</span><span class="sc">%s</span><span class="st">.nii.gz'</span>) <span class="op">%</span> (MasksDir, Masks[j])</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>        <span class="co"># output mask path in postop space:</span></span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>        <span class="co">#   &lt;sub&gt;/seedmasksINpostop_9b/&lt;ROI&gt;_postop.nii.gz</span></span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>        fnOutput <span class="op">=</span> <span class="bu">str</span>(<span class="st">'</span><span class="sc">%s</span><span class="st">'</span> <span class="op">+</span> <span class="st">'/</span><span class="sc">%s</span><span class="st">_postop.nii.gz'</span>) <span class="op">%</span> (OutDir, Masks[j])</span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>        <span class="co"># antsApplyTransforms:</span></span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>        <span class="co">#   -d 3             : 3D images</span></span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>        <span class="co">#   -r fnTranBrainNii: reference image (postop)</span></span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>        <span class="co">#   -i fnROImask     : input ROI mask in T1 space</span></span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>        <span class="co">#   -o fnOutput      : output ROI in postop space</span></span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>        <span class="co">#   -n NearestNeighbor : preserve binary labels</span></span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>        <span class="co">#   -t [fnAff_MNIaff,1] : apply inverse of postop -&gt; T1 affine</span></span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>        cmd_applyANTS <span class="op">=</span> (</span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>            <span class="st">'antsApplyTransforms -d 3 -r </span><span class="sc">%s</span><span class="st"> -i </span><span class="sc">%s</span><span class="st"> -o </span><span class="sc">%s</span><span class="st"> '</span></span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a>            <span class="st">'-n NearestNeighbor -t [</span><span class="sc">%s</span><span class="st">,1]'</span></span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">%</span> (fnTranBrainNii, fnROImask, fnOutput, fnAff_MNIaff)</span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print command for logging/debugging</span></span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(cmd_applyANTS) </span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>        <span class="co"># execute transform: warp ROI from T1 space into postop space</span></span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>        os.system(cmd_applyANTS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lesion–tract overlap was quantified in Python using voxel-wise logical operations. Overlap volume was defined as the number of voxels shared between the lesion mask and each tract mask, multiplied by voxel volume.</p>
<div class="cell" data-python.reticulate="false">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> nibabel <span class="im">as</span> nib</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fnmatch</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># set FSL to use simple linux utility for resource management (SLURM) for parallelization</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>os.system(<span class="st">"export FSLPARALLEL=slurm"</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co"># print CSV header rows for results</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"subject, mask, voi, volume_L_mask, volume_R_mask, volume_voi, voxel_overlap_L, voxel_overlap_R, weighted_voxel_overlap_L, weighted_voxel_overlap_R, coefficient_L, coefficient_R, weighted_coefficient_L, weighted_coefficient_R"</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co"># coefficient = (# of volume of interest (VOI) voxels overlapping with mask) / (total # of VOI voxels)</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co"># weighted coefficient = (sum of probability-weighted overlapping voxels) / (total # of VOI voxels)</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="co"># discover subject directories:</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co">#   each "subjects_dir[i]" is a &lt;subject&gt;/preop folder</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>subjects_dir <span class="op">=</span> <span class="bu">list</span>(glob.glob(<span class="st">"/media/halpernlab/Expansion2/Targeting_storage/FUS/subjects/preop_immPost/sub*/preop"</span>))  <span class="co"># CHANGE DIRECTORY as needed</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(subjects_dir)):</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># arguments:</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   sys.argv[1] = mask name base</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   sys.argv[2] = VOI filename base</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> sys.argv[<span class="dv">1</span>]</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    voi_input <span class="op">=</span> sys.argv[<span class="dv">2</span>]</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># path where masks in postop space are stored:</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   &lt;subject&gt;/preop/seedmasksINpostop</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    mask_dir <span class="op">=</span> <span class="bu">str</span>(<span class="st">"</span><span class="sc">%s</span><span class="st">/"</span> <span class="op">+</span> <span class="st">"seedmasksINpostop"</span>) <span class="op">%</span> subjects_dir[i]</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># path to VOI volume for a subject:</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   &lt;subject&gt;/preop/&lt;voi_input&gt;.nii.gz</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    voi <span class="op">=</span> <span class="bu">str</span>(<span class="st">"</span><span class="sc">%s</span><span class="st">/"</span> <span class="op">+</span> <span class="st">"</span><span class="sc">%s</span><span class="st">.nii.gz"</span>) <span class="op">%</span> (subjects_dir[i], voi_input)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># only proceed if the VOI volume exists for the subject</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(voi):</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># load LEFT hemisphere mask</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>        mask_3d_l <span class="op">=</span> <span class="bu">str</span>(<span class="st">"</span><span class="sc">%s</span><span class="st">/"</span> <span class="op">+</span> <span class="st">"</span><span class="sc">%s</span><span class="st">"</span> <span class="op">+</span> <span class="st">"_L_T1_postop.nii.gz"</span>) <span class="op">%</span> (mask_dir, mask)</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(mask_3d_l)</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>        vol_l <span class="op">=</span> nib.load(mask_3d_l)          <span class="co"># load left mask NIfTI</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>        vol_l_data <span class="op">=</span> vol_l.get_fdata()       <span class="co"># get data as NumPy array</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>        vol_l_nonzer <span class="op">=</span> np.nonzero(vol_l_data)  <span class="co"># indices where mask &gt;0</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>        vol_l_nonzero <span class="op">=</span> vol_l_nonzer[<span class="dv">1</span>]      <span class="co"># taking index array along axis 1</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>        mask_l <span class="op">=</span> <span class="bu">len</span>(vol_l_nonzero)          <span class="co"># number of nonzero voxels in L mask</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># repeat for RIGHT hemisphere mask</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>        mask_3d_r <span class="op">=</span> <span class="bu">str</span>(<span class="st">"</span><span class="sc">%s</span><span class="st">/"</span> <span class="op">+</span> <span class="st">"</span><span class="sc">%s</span><span class="st">"</span> <span class="op">+</span> <span class="st">"_R_T1_postop.nii.gz"</span>) <span class="op">%</span> (mask_dir, mask)</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>        vol_r <span class="op">=</span> nib.load(mask_3d_r)</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>        vol_r_data <span class="op">=</span> vol_r.get_fdata()</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>        vol_r_nonzer <span class="op">=</span> np.nonzero(vol_r_data)</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>        vol_r_nonzero <span class="op">=</span> vol_r_nonzer[<span class="dv">1</span>]</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>        mask_r <span class="op">=</span> <span class="bu">len</span>(vol_r_nonzero)</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># load VOI</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>        voi_3d <span class="op">=</span> nib.load(voi)</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>        voi_data <span class="op">=</span> voi_3d.get_fdata()</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>        voi_nonzer <span class="op">=</span> np.nonzero(voi_data)</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>        voi_nonzero <span class="op">=</span> voi_nonzer[<span class="dv">1</span>]</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>        voi_vol <span class="op">=</span> <span class="bu">len</span>(voi_nonzero)           <span class="co"># total number of nonzero VOI voxels</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>        <span class="co"># calculate overlap via FSL: multiply VOI by mask to obtain overlapping voxels:</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>        <span class="co">#   non-overlapping voxels become 0; overlapping voxels retain VOI intensity</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>        <span class="co"># make overlap output directory:</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>        <span class="co">#   &lt;subject&gt;/preop/overlap/</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>        overlap_dir <span class="op">=</span> <span class="bu">str</span>(<span class="st">"</span><span class="sc">%s</span><span class="st">/"</span> <span class="op">+</span> <span class="st">"overlap"</span>) <span class="op">%</span> subjects_dir[i]</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> os.path.exists(overlap_dir):</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>            mkoverlapdir <span class="op">=</span> <span class="st">"mkdir </span><span class="sc">%s</span><span class="st">"</span> <span class="op">%</span> overlap_dir</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>            os.system(mkoverlapdir)</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>        <span class="co"># LEFT hemisphere overlap</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>        <span class="co">#   Output: &lt;subject&gt;/preop/overlap/&lt;voi_input&gt;_&lt;mask&gt;_L_T1_postop.nii.gz</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>        mult_l_output <span class="op">=</span> <span class="bu">str</span>(<span class="st">"</span><span class="sc">%s</span><span class="st">/</span><span class="sc">%s</span><span class="st">_</span><span class="sc">%s</span><span class="st">_L_T1_postop.nii.gz"</span>) <span class="op">%</span> (overlap_dir, voi_input, mask)</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>        <span class="co"># multiply VOI by LEFT mask</span></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>        mult_l_cmd <span class="op">=</span> <span class="st">'fslmaths </span><span class="sc">%s</span><span class="st"> -mul </span><span class="sc">%s</span><span class="st"> </span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> (voi, mask_3d_l, mult_l_output)</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>        os.system(mult_l_cmd)</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>        mult_l <span class="op">=</span> nib.load(mult_l_output)</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>        mult_l_data <span class="op">=</span> mult_l.get_fdata()</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>        mult_l_nonzer <span class="op">=</span> np.nonzero(mult_l_data)</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>        mult_l_nonzero <span class="op">=</span> mult_l_nonzer[<span class="dv">1</span>]</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>        overlap_l <span class="op">=</span> <span class="bu">len</span>(mult_l_nonzero)      <span class="co"># raw count of overlapping voxels (LEFT)</span></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>        <span class="co"># RIGHT hemisphere overlap</span></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>        <span class="co">#   Output: &lt;subject&gt;/preop/overlap/&lt;voi_input&gt;_&lt;mask&gt;_R_T1_postop.nii.gz</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>        mult_r_output <span class="op">=</span> <span class="bu">str</span>(<span class="st">"</span><span class="sc">%s</span><span class="st">/</span><span class="sc">%s</span><span class="st">_</span><span class="sc">%s</span><span class="st">_R_T1_postop.nii.gz"</span>) <span class="op">%</span> (overlap_dir, voi_input, mask)</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For RIGHT: bin VOI first, then multiply by R mask</span></span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>        mult_r_cmd <span class="op">=</span> <span class="st">'fslmaths </span><span class="sc">%s</span><span class="st"> -bin -mul </span><span class="sc">%s</span><span class="st"> </span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> (voi, mask_3d_r, mult_r_output)</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>        os.system(mult_r_cmd)</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>        mult_r <span class="op">=</span> nib.load(mult_r_output)</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>        mult_r_data <span class="op">=</span> mult_r.get_fdata()</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>        mult_r_nonzer <span class="op">=</span> np.nonzero(mult_r_data)</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>        mult_r_nonzero <span class="op">=</span> mult_r_nonzer[<span class="dv">1</span>]</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>        overlap_r <span class="op">=</span> <span class="bu">len</span>(mult_r_nonzero)      <span class="co"># raw count of overlapping voxels (RIGHT)</span></span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>        <span class="co"># weighted overlap (using mean intensity of overlap)</span></span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for each overlap image, use fslstats:</span></span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>        <span class="co">#   -M = mean intensity of voxels &gt;0</span></span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>        <span class="co">#   -V = "N_voxels volume_mm3": we only use N_voxels</span></span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>        <span class="co"># LEFT weighted overlap</span></span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>        get_avg_mult_l <span class="op">=</span> <span class="st">'fslstats </span><span class="sc">%s</span><span class="st"> -M'</span> <span class="op">%</span> mult_l_output</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>        avg_mult_l <span class="op">=</span> subprocess.check_output(get_avg_mult_l, shell<span class="op">=</span><span class="va">True</span>).decode(<span class="st">'ascii'</span>)</span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>        avg_mult_l <span class="op">=</span> <span class="bu">float</span>(avg_mult_l)   <span class="co"># mean intensity in LEFT overlap</span></span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>        get_vol_mult_l <span class="op">=</span> <span class="st">'fslstats </span><span class="sc">%s</span><span class="st"> -V'</span> <span class="op">%</span> mult_l_output</span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>        vol_mult_l <span class="op">=</span> subprocess.check_output(get_vol_mult_l, shell<span class="op">=</span><span class="va">True</span>).decode(<span class="st">'ascii'</span>)</span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>        <span class="co"># vol_mult_l returns "Nvoxels volume_mm3"; take Nvoxels</span></span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>        vol_mult_l <span class="op">=</span> <span class="bu">float</span>(vol_mult_l[:vol_mult_l.find(<span class="st">' '</span>)])</span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Weighted overlap = sum(probabilities) ≈ Nvoxels * mean_intensity</span></span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>        wgt_overlap_l <span class="op">=</span> vol_mult_l <span class="op">*</span> avg_mult_l</span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>        <span class="co"># RIGHT weighted overlap</span></span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>        get_avg_mult_r <span class="op">=</span> <span class="st">'fslstats </span><span class="sc">%s</span><span class="st"> -M'</span> <span class="op">%</span> mult_r_output</span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>        avg_mult_r <span class="op">=</span> subprocess.check_output(get_avg_mult_r, shell<span class="op">=</span><span class="va">True</span>).decode(<span class="st">'ascii'</span>)</span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>        avg_mult_r <span class="op">=</span> <span class="bu">float</span>(avg_mult_r)</span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>        get_vol_mult_r <span class="op">=</span> <span class="st">'fslstats </span><span class="sc">%s</span><span class="st"> -V'</span> <span class="op">%</span> mult_r_output</span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a>        vol_mult_r <span class="op">=</span> subprocess.check_output(get_vol_mult_r, shell<span class="op">=</span><span class="va">True</span>).decode(<span class="st">'ascii'</span>)</span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>        vol_mult_r <span class="op">=</span> <span class="bu">float</span>(vol_mult_r[:vol_mult_r.find(<span class="st">' '</span>)])</span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>        wgt_overlap_r <span class="op">=</span> vol_mult_r <span class="op">*</span> avg_mult_r</span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>        <span class="co"># overlap coefficient = (# overlap voxels) / (total VOI voxels)</span></span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a>        coeff_L <span class="op">=</span> np.true_divide(overlap_l, voi_vol)</span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a>        coeff_R <span class="op">=</span> np.true_divide(overlap_r, voi_vol)</span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a>        <span class="co"># weighted coefficient = (weighted overlap sum) / (total VOI voxels)</span></span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a>        wgt_coeff_L <span class="op">=</span> np.true_divide(wgt_overlap_l, voi_vol)</span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>        wgt_coeff_R <span class="op">=</span> np.true_divide(wgt_overlap_r, voi_vol)</span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a>        <span class="co"># CSV output line</span></span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(</span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a>            subjects_dir[i],</span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a>            mask,</span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a>            voi_input,</span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a>            mask_l,</span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a>            mask_r,</span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a>            voi_vol,</span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a>            overlap_l,</span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a>            overlap_r,</span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a>            wgt_overlap_l,</span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a>            wgt_overlap_r,</span>
<span id="cb4-148"><a href="#cb4-148" aria-hidden="true" tabindex="-1"></a>            coeff_L,</span>
<span id="cb4-149"><a href="#cb4-149" aria-hidden="true" tabindex="-1"></a>            coeff_R,</span>
<span id="cb4-150"><a href="#cb4-150" aria-hidden="true" tabindex="-1"></a>            wgt_coeff_L,</span>
<span id="cb4-151"><a href="#cb4-151" aria-hidden="true" tabindex="-1"></a>            wgt_coeff_R,</span>
<span id="cb4-152"><a href="#cb4-152" aria-hidden="true" tabindex="-1"></a>            sep<span class="op">=</span><span class="st">","</span></span>
<span id="cb4-153"><a href="#cb4-153" aria-hidden="true" tabindex="-1"></a>        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Percent tract coverage was calculated as overlap volume divided by total tract volume. Metrics were computed separately for the ansa lenticularis and the lenticular fasciculus.</p>
<p>Motor function was assessed using the Unified Parkinson’s Disease Rating Scale, Part III (UPDRS-III). The primary clinical endpoint was change in motor severity, defined as:</p>
<p>ΔUPDRS-III = Post-operative score − Pre-operative score.</p>
<p>Negative values indicate improvement, however this was then adjusted to percentage (absolute value) for analyses.</p>
</section>
<section id="results-and-analysis" class="level2">
<h2 class="anchored" data-anchor-id="results-and-analysis">Results and Analysis</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># libraries used for my analyses</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pROC)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(corrplot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First the data was read in from csv files, one of clinical data and one of imaging data, stored in my project directory, before being cleaned and merged on Subject ID column. Because much of the clinical response data is collected at 6-months post-op timepoint, there are unfortunately missing datapoints for the most recent completed procedures in this dataset. The data for the first 11 subjects is previewed below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read data</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>clinical <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"clinical_data.csv"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>overlap  <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"combined_overlap.csv"</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># clean clinical data</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>clinical_clean <span class="ot">&lt;-</span> clinical <span class="sc">%&gt;%</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">subject_id =</span> ID) <span class="sc">%&gt;%</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">matches</span>(<span class="st">"^Unnamed"</span>)) <span class="sc">%&gt;%</span>   <span class="co"># drops unnamned column (there was at least one with extra clinical notes)</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject_id =</span> <span class="fu">as.integer</span>(subject_id),</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">Response =</span> <span class="fu">as.factor</span>(Response)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co"># clean overlap data</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>overlap_clean <span class="ot">&lt;-</span> overlap <span class="sc">%&gt;%</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">subject_id =</span> ID) <span class="sc">%&gt;%</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject_id =</span> <span class="fu">as.integer</span>(subject_id),</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># convert percent strings like "7.30%" -&gt; 7.30</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_overlap_LF =</span> <span class="fu">as.numeric</span>(<span class="fu">str_remove</span>(<span class="st">`</span><span class="at">% Overlap LF</span><span class="st">`</span>, <span class="st">"%"</span>)),</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_overlap_AL =</span> <span class="fu">as.numeric</span>(<span class="fu">str_remove</span>(<span class="st">`</span><span class="at">% Overlap AL</span><span class="st">`</span>, <span class="st">"%"</span>))</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    subject_id,</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">lesion_vol_mm3 =</span> <span class="st">`</span><span class="at">Lesion Vol</span><span class="st">`</span>,</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">overlap_LF_mm3 =</span> <span class="st">`</span><span class="at">Overlap LF</span><span class="st">`</span>,</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">overlap_AL_mm3 =</span> <span class="st">`</span><span class="at">Overlap AL</span><span class="st">`</span>,</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    pct_overlap_LF, </span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    pct_overlap_AL</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="co"># merge datasets</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> clinical_clean <span class="sc">%&gt;%</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(overlap_clean, <span class="at">by =</span> <span class="st">"subject_id"</span>)</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a><span class="co"># check merge</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 27
Columns: 28
$ subject_id                &lt;int&gt; 1, 2, 3, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, …
$ Age                       &lt;dbl&gt; 61.7, 61.0, 64.3, 82.2, 76.6, 57.2, 63.3, 57…
$ Diagnosis                 &lt;chr&gt; "Parkinson's", "Parkinson's", "Parkinson's",…
$ Side                      &lt;chr&gt; "Right", "Left", "Left", "Left", "Left", "Ri…
$ Target                    &lt;chr&gt; "GPI", "GPI", "GPI", "GPI", "GPI", "GPI", "G…
$ SDR                       &lt;dbl&gt; 0.46, 0.53, 0.54, 0.34, 0.59, 0.31, 0.38, 0.…
$ Preop                     &lt;dbl&gt; 27, 10, 30, 31, NA, 21, 30, NA, 27, 15, NA, …
$ Postop                    &lt;dbl&gt; NA, 8, 28, 18, NA, 19, 27, NA, NA, NA, NA, 3…
$ Response                  &lt;fct&gt; 1, 1, 0, 1, 1, 0, 1, NA, 1, NA, NA, 0, 1, 1,…
$ `Preop UPDRS III`         &lt;chr&gt; "27", "10", "30", "31", NA, "21", "30", NA, …
$ `Postop UPDRS`            &lt;chr&gt; NA, "8", "28", "19 -&gt; 16", NA, "19", "27", N…
$ Outcome                   &lt;chr&gt; "Improved", "Excellent response; filled surv…
$ `Cavitation / Technical`  &lt;chr&gt; "N", "N", "Y", "N", "N", "N", "Y", "Y", "Y",…
$ `Failed T`                &lt;chr&gt; "N", "N", "N", "N", "N", "Y", "Y", "N", "N",…
$ `# sonications (all)`     &lt;dbl&gt; 8, 11, 10, 6, 8, 6, 5, 7, 8, 13, 7, 10, 10, …
$ `Sonications (delivered)` &lt;dbl&gt; 8, 10, 7, 6, 8, 6, 5, 6, 6, 7, 7, 10, 7, 9, …
$ `Max Energy (J)`          &lt;dbl&gt; 20926, 27504, 32212, 42600, 21904, 45099, 40…
$ `MaxAv Temp`              &lt;dbl&gt; 56.9, 54.1, 51.7, 51.2, 54.6, 45.9, 49.2, 51…
$ `MaxMax Temp`             &lt;chr&gt; "61.1", "56.6", "54.1", "55.6", "56.9", "49.…
$ Note                      &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
$ `Adverse Events`          &lt;chr&gt; "Foot numbness", "Brain fog; Balance; Olfact…
$ Resolved                  &lt;chr&gt; "Yes", "Yes", "?", "4-5 weeks", "Yes", NA, "…
$ ...23                     &lt;chr&gt; NA, NA, "high sinuses note in SDR", NA, NA, …
$ lesion_vol_mm3            &lt;dbl&gt; 94.00000, 133.50000, 68.50000, 54.50000, 187…
$ overlap_LF_mm3            &lt;dbl&gt; 0.5000000, 2.5000000, 5.0000000, 1.0000000, …
$ overlap_AL_mm3            &lt;dbl&gt; 0.000000, 0.000000, 0.000000, 0.000000, 0.00…
$ pct_overlap_LF            &lt;dbl&gt; 0.53, 1.87, 7.30, 1.83, 6.68, 0.00, 0.00, 0.…
$ pct_overlap_AL            &lt;dbl&gt; 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(dat, <span class="dv">10</span>),</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">caption =</span> <span class="st">"Preview of Merged Dataset"</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Preview of Merged Dataset</caption>
<colgroup>
<col style="width: 1%">
<col style="width: 0%">
<col style="width: 1%">
<col style="width: 0%">
<col style="width: 1%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 1%">
<col style="width: 1%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 37%">
<col style="width: 3%">
<col style="width: 1%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 2%">
<col style="width: 1%">
<col style="width: 1%">
<col style="width: 0%">
<col style="width: 9%">
<col style="width: 1%">
<col style="width: 4%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 2%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">subject_id</th>
<th style="text-align: right;">Age</th>
<th style="text-align: left;">Diagnosis</th>
<th style="text-align: left;">Side</th>
<th style="text-align: left;">Target</th>
<th style="text-align: right;">SDR</th>
<th style="text-align: right;">Preop</th>
<th style="text-align: right;">Postop</th>
<th style="text-align: left;">Response</th>
<th style="text-align: left;">Preop UPDRS III</th>
<th style="text-align: left;">Postop UPDRS</th>
<th style="text-align: left;">Outcome</th>
<th style="text-align: left;">Cavitation / Technical</th>
<th style="text-align: left;">Failed T</th>
<th style="text-align: right;"># sonications (all)</th>
<th style="text-align: right;">Sonications (delivered)</th>
<th style="text-align: right;">Max Energy (J)</th>
<th style="text-align: right;">MaxAv Temp</th>
<th style="text-align: left;">MaxMax Temp</th>
<th style="text-align: left;">Note</th>
<th style="text-align: left;">Adverse Events</th>
<th style="text-align: left;">Resolved</th>
<th style="text-align: left;">…23</th>
<th style="text-align: right;">lesion_vol_mm3</th>
<th style="text-align: right;">overlap_LF_mm3</th>
<th style="text-align: right;">overlap_AL_mm3</th>
<th style="text-align: right;">pct_overlap_LF</th>
<th style="text-align: right;">pct_overlap_AL</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">61.7</td>
<td style="text-align: left;">Parkinson’s</td>
<td style="text-align: left;">Right</td>
<td style="text-align: left;">GPI</td>
<td style="text-align: right;">0.46</td>
<td style="text-align: right;">27</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">27</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">Improved</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">N</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">20926</td>
<td style="text-align: right;">56.9</td>
<td style="text-align: left;">61.1</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">Foot numbness</td>
<td style="text-align: left;">Yes</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">94.0000</td>
<td style="text-align: right;">0.500000</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.53</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">61.0</td>
<td style="text-align: left;">Parkinson’s</td>
<td style="text-align: left;">Left</td>
<td style="text-align: left;">GPI</td>
<td style="text-align: right;">0.53</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">8</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">10</td>
<td style="text-align: left;">8</td>
<td style="text-align: left;">Excellent response; filled survey</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">N</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">27504</td>
<td style="text-align: right;">54.1</td>
<td style="text-align: left;">56.6</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">Brain fog; Balance; Olfactory issues (also received chemo)</td>
<td style="text-align: left;">Yes</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">133.5000</td>
<td style="text-align: right;">2.500000</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.87</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">64.3</td>
<td style="text-align: left;">Parkinson’s</td>
<td style="text-align: left;">Left</td>
<td style="text-align: left;">GPI</td>
<td style="text-align: right;">0.54</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">28</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">30</td>
<td style="text-align: left;">28</td>
<td style="text-align: left;">Unchanged?</td>
<td style="text-align: left;">Y</td>
<td style="text-align: left;">N</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">32212</td>
<td style="text-align: right;">51.7</td>
<td style="text-align: left;">54.1</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">Headache, Balance, Speech, numbness</td>
<td style="text-align: left;">?</td>
<td style="text-align: left;">high sinuses note in SDR</td>
<td style="text-align: right;">68.5000</td>
<td style="text-align: right;">5.000000</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">7.30</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: right;">82.2</td>
<td style="text-align: left;">Parkinson’s</td>
<td style="text-align: left;">Left</td>
<td style="text-align: left;">GPI</td>
<td style="text-align: right;">0.34</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">18</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">31</td>
<td style="text-align: left;">19 -&gt; 16</td>
<td style="text-align: left;">Transient tremor relief –&gt; left thalamotomy</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">N</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">42600</td>
<td style="text-align: right;">51.2</td>
<td style="text-align: left;">55.6</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">Gait</td>
<td style="text-align: left;">4-5 weeks</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">54.5000</td>
<td style="text-align: right;">1.000000</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.83</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">6</td>
<td style="text-align: right;">76.6</td>
<td style="text-align: left;">Parkinson’s</td>
<td style="text-align: left;">Left</td>
<td style="text-align: left;">GPI</td>
<td style="text-align: right;">0.59</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">Dyskinesia, rigidity better. dyskinesias have significantly improved</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">N</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">21904</td>
<td style="text-align: right;">54.6</td>
<td style="text-align: left;">56.9</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">Balance</td>
<td style="text-align: left;">Yes</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">187.0000</td>
<td style="text-align: right;">12.500000</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">6.68</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">7</td>
<td style="text-align: right;">57.2</td>
<td style="text-align: left;">Parkinson’s</td>
<td style="text-align: left;">Right</td>
<td style="text-align: left;">GPI</td>
<td style="text-align: right;">0.31</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">19</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">21</td>
<td style="text-align: left;">19</td>
<td style="text-align: left;">2 targets (2,3) planned. 2 sonications at target 1 (0.5mm medial, 0.5mm inf adj); 1 sonication at target 2. Tremor, rigidity better. did not enjoy much symptom relief (limited pallidal ablation owing to low skull density ratio</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">Y</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">45099</td>
<td style="text-align: right;">45.9</td>
<td style="text-align: left;">49.1</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">0.000000</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">8</td>
<td style="text-align: right;">63.3</td>
<td style="text-align: left;">Parkinson’s</td>
<td style="text-align: left;">Right</td>
<td style="text-align: left;">GPI</td>
<td style="text-align: right;">0.38</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">27</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">30</td>
<td style="text-align: left;">27</td>
<td style="text-align: left;">minimal resolution of the LUE tremor</td>
<td style="text-align: left;">Y</td>
<td style="text-align: left;">Y</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">40183</td>
<td style="text-align: right;">49.2</td>
<td style="text-align: left;">51.1</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">Balance, speech,</td>
<td style="text-align: left;">Yes</td>
<td style="text-align: left;">lost to follow up</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">0.000000</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">9</td>
<td style="text-align: right;">57.0</td>
<td style="text-align: left;">Parkinson’s</td>
<td style="text-align: left;">Left</td>
<td style="text-align: left;">GPI</td>
<td style="text-align: right;">0.45</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">Initial 80% tremor improved but some tremor returned (dyskinesia same)–&gt; had DBS subsequently</td>
<td style="text-align: left;">Y</td>
<td style="text-align: left;">N</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">41355</td>
<td style="text-align: right;">51.6</td>
<td style="text-align: left;">54.1</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">45.5000</td>
<td style="text-align: right;">0.000000</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">10</td>
<td style="text-align: right;">81.3</td>
<td style="text-align: left;">Parkinson’s</td>
<td style="text-align: left;">Right</td>
<td style="text-align: left;">GPI</td>
<td style="text-align: right;">0.66</td>
<td style="text-align: right;">27</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">27</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">speech better (diaphragm dyskinesia); voice better. “overall big improvement”. Passed away</td>
<td style="text-align: left;">Y</td>
<td style="text-align: left;">N</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">14009</td>
<td style="text-align: right;">54.1</td>
<td style="text-align: left;">56.9</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">145.8197</td>
<td style="text-align: right;">3.186715</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2.19</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">11</td>
<td style="text-align: right;">80.3</td>
<td style="text-align: left;">Parkinson’s</td>
<td style="text-align: left;">Left</td>
<td style="text-align: left;">GPI</td>
<td style="text-align: right;">0.53</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">15</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">Y</td>
<td style="text-align: left;">N</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">12610</td>
<td style="text-align: right;">56.1</td>
<td style="text-align: left;">61.2</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">Fogginess, speech, generalized weakness</td>
<td style="text-align: left;">Yes</td>
<td style="text-align: left;">lost to follow up</td>
<td style="text-align: right;">85.5000</td>
<td style="text-align: right;">0.500000</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.58</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Next, the clinical metric of response was calculated for each patient with available data and added as in a new column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate percent improvement based on UPDRS pre- and post- scores</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">score_change =</span> Postop <span class="sc">-</span> Preop,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_improve =</span> <span class="fu">abs</span>(<span class="dv">100</span> <span class="sc">*</span> (Postop <span class="sc">-</span> Preop) <span class="sc">/</span> Postop)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(dat) <span class="co"># check data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 27
Columns: 30
$ subject_id                &lt;int&gt; 1, 2, 3, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, …
$ Age                       &lt;dbl&gt; 61.7, 61.0, 64.3, 82.2, 76.6, 57.2, 63.3, 57…
$ Diagnosis                 &lt;chr&gt; "Parkinson's", "Parkinson's", "Parkinson's",…
$ Side                      &lt;chr&gt; "Right", "Left", "Left", "Left", "Left", "Ri…
$ Target                    &lt;chr&gt; "GPI", "GPI", "GPI", "GPI", "GPI", "GPI", "G…
$ SDR                       &lt;dbl&gt; 0.46, 0.53, 0.54, 0.34, 0.59, 0.31, 0.38, 0.…
$ Preop                     &lt;dbl&gt; 27, 10, 30, 31, NA, 21, 30, NA, 27, 15, NA, …
$ Postop                    &lt;dbl&gt; NA, 8, 28, 18, NA, 19, 27, NA, NA, NA, NA, 3…
$ Response                  &lt;fct&gt; 1, 1, 0, 1, 1, 0, 1, NA, 1, NA, NA, 0, 1, 1,…
$ `Preop UPDRS III`         &lt;chr&gt; "27", "10", "30", "31", NA, "21", "30", NA, …
$ `Postop UPDRS`            &lt;chr&gt; NA, "8", "28", "19 -&gt; 16", NA, "19", "27", N…
$ Outcome                   &lt;chr&gt; "Improved", "Excellent response; filled surv…
$ `Cavitation / Technical`  &lt;chr&gt; "N", "N", "Y", "N", "N", "N", "Y", "Y", "Y",…
$ `Failed T`                &lt;chr&gt; "N", "N", "N", "N", "N", "Y", "Y", "N", "N",…
$ `# sonications (all)`     &lt;dbl&gt; 8, 11, 10, 6, 8, 6, 5, 7, 8, 13, 7, 10, 10, …
$ `Sonications (delivered)` &lt;dbl&gt; 8, 10, 7, 6, 8, 6, 5, 6, 6, 7, 7, 10, 7, 9, …
$ `Max Energy (J)`          &lt;dbl&gt; 20926, 27504, 32212, 42600, 21904, 45099, 40…
$ `MaxAv Temp`              &lt;dbl&gt; 56.9, 54.1, 51.7, 51.2, 54.6, 45.9, 49.2, 51…
$ `MaxMax Temp`             &lt;chr&gt; "61.1", "56.6", "54.1", "55.6", "56.9", "49.…
$ Note                      &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
$ `Adverse Events`          &lt;chr&gt; "Foot numbness", "Brain fog; Balance; Olfact…
$ Resolved                  &lt;chr&gt; "Yes", "Yes", "?", "4-5 weeks", "Yes", NA, "…
$ ...23                     &lt;chr&gt; NA, NA, "high sinuses note in SDR", NA, NA, …
$ lesion_vol_mm3            &lt;dbl&gt; 94.00000, 133.50000, 68.50000, 54.50000, 187…
$ overlap_LF_mm3            &lt;dbl&gt; 0.5000000, 2.5000000, 5.0000000, 1.0000000, …
$ overlap_AL_mm3            &lt;dbl&gt; 0.000000, 0.000000, 0.000000, 0.000000, 0.00…
$ pct_overlap_LF            &lt;dbl&gt; 0.53, 1.87, 7.30, 1.83, 6.68, 0.00, 0.00, 0.…
$ pct_overlap_AL            &lt;dbl&gt; 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.…
$ score_change              &lt;dbl&gt; NA, -2, -2, -13, NA, -2, -3, NA, NA, NA, NA,…
$ pct_improve               &lt;dbl&gt; NA, 25.000000, 7.142857, 72.222222, NA, 10.5…</code></pre>
</div>
</div>
<p>Descriptive analyses were performed to visualize specific components of our dataset. This bar plot shows the number of patients with varying amounts (mm3) of ablation field overlap of the lenticular fasciculus (LF overlap).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># distribution of LF overlap</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> overlap_LF_mm3)) <span class="sc">+</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">10</span>, <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"LF overlap (mm³)"</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution of lenticular fasciculus overlap"</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="BMIN5030_FinalProject_Ballard_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This plot shows binary clinical response or NA, plotted against LF overlap. The trend of response after LF overlap in treatment is apparent.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># LF overlap and response</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> Response, <span class="at">y =</span> overlap_LF_mm3, <span class="at">fill =</span> Response)) <span class="sc">+</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">width =</span> <span class="fl">0.1</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Clinical response"</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"LF overlap (mm³)"</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"LF overlap by response status"</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="BMIN5030_FinalProject_Ballard_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>To get more granular, I plotted the relationship between LF overlap and the clinical improvement metric, percent improvement in UPDRS score from pre- to post-op. The trend is clear, however there are outliers.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># LF overlap vs UPDRS % improvement</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(overlap_LF_mm3, pct_improve)) <span class="sc">+</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"LF overlap (mm³)"</span>,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"UPDRS Percent improvement"</span>,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Relationship between LF overlap and clinical improvement"</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="BMIN5030_FinalProject_Ballard_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>To add another descriptive figure of variable correlations, I generated the heatmap below for our key variables. This visualizes some important relationships in our dataset: LF overlap and percent improvement have a positive correlation, and age and percent improvement have a negative correlation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># descriptive heatmap of variable relationships</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(overlap_LF_mm3, overlap_AL_mm3, pct_improve, Age, SDR, <span class="st">`</span><span class="at">Sonications (delivered)</span><span class="st">`</span>, <span class="st">`</span><span class="at">MaxAv Temp</span><span class="st">`</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>cor_mat <span class="ot">&lt;-</span> <span class="fu">cor</span>(vars, <span class="at">use =</span> <span class="st">"complete.obs"</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="fu">corrplot</span>(</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  cor_mat,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"color"</span>,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"upper"</span>,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">tl.col =</span> <span class="st">"black"</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="BMIN5030_FinalProject_Ballard_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>I began analyses with a simple correlation test to determine if there is a linear association between our key variables: tract-lesion overlap and percent improvement. Given the small sample size, this cor value is encouraging, as it demonstrates positive associations for each tract overlap with percent improvement, though the magnitude is quite small. The additional results show that the correlation is not statistically significant (p-value), is underpowered (degrees of freedom), and that the true correlation could vary quite a bit from the result provided (confidence intervals).</p>
<p>The results were visualized in order to more easily keep our outliers in mind.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># simple correlation analyses for LF and AL overlaps</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cor.test</span>(dat<span class="sc">$</span>overlap_LF_mm3, dat<span class="sc">$</span>pct_improve, <span class="at">use =</span> <span class="st">"complete.obs"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Pearson's product-moment correlation

data:  dat$overlap_LF_mm3 and dat$pct_improve
t = 1.0125, df = 11, p-value = 0.333
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.3086517  0.7261507
sample estimates:
      cor 
0.2919902 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor.test</span>(dat<span class="sc">$</span>overlap_AL_mm3, dat<span class="sc">$</span>pct_improve, <span class="at">use =</span> <span class="st">"complete.obs"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Pearson's product-moment correlation

data:  dat$overlap_AL_mm3 and dat$pct_improve
t = 0.46713, df = 11, p-value = 0.6495
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.4457712  0.6411828
sample estimates:
      cor 
0.1394697 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> overlap_LF_mm3, <span class="at">y =</span> pct_improve)) <span class="sc">+</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Lenticular fasciculus overlap (mm³)"</span>,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"UPDRS III % improvement"</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="BMIN5030_FinalProject_Ballard_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> overlap_AL_mm3, <span class="at">y =</span> pct_improve)) <span class="sc">+</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Ansa lenticularis overlap (mm³)"</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"UPDRS III % improvement"</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="BMIN5030_FinalProject_Ballard_files/figure-html/unnamed-chunk-12-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Next I performed a multi-variable exploratory linear regression. Again, not statistically significant. This regression suffered from the number of predictors included (overfitting), which explains the large drop in R-squared value after adjustment.</p>
<p>Regardless, the model identified signals from our predictors (listed strongest to weakest t-values):</p>
<p>Lower SDR associates with worse outcomes - This is interesting because a lower skull density ratio indicates that more ultrasound energy will be absorbed or deflected by the skull, reducing treatment effect. So biologically this makes sense.</p>
<p>Higher peak temperature associates with better outcomes - This is clinically true, to an extent, because if the temperature does not reach around 51 degrees Celsius, the tissue will not be ablated and treatment will be less effective.</p>
<p>Higher LF overlap associates with better outcomes - Encouraging to see agreement with our hypothesis again.</p>
<p>More sonications associates with better outcomes - Probably heavily confounded by lesion size and treatment plan.</p>
<p>AL overlap does not show a consistent independent association. - This makes sense given the extremely small sample size of evaluable patients with AL overlap (one).</p>
<p>Increased age associates with worse outcomes. - While not a strong signal this does make sense clinically.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># multi-variable exploratory linear regression</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>dat_scaled <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(overlap_LF_mm3, overlap_AL_mm3, Age, SDR, <span class="st">`</span><span class="at">Sonications (delivered)</span><span class="st">`</span>, <span class="st">`</span><span class="at">MaxAv Temp</span><span class="st">`</span>),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span> <span class="fu">scale</span>(.x) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>model_lm_scaled <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  pct_improve <span class="sc">~</span> overlap_LF_mm3 <span class="sc">+</span> overlap_AL_mm3 <span class="sc">+</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    Age <span class="sc">+</span> SDR <span class="sc">+</span> <span class="st">`</span><span class="at">Sonications (delivered)</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">MaxAv Temp</span><span class="st">`</span>,</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dat_scaled</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_lm_scaled)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = pct_improve ~ overlap_LF_mm3 + overlap_AL_mm3 + 
    Age + SDR + `Sonications (delivered)` + `MaxAv Temp`, data = dat_scaled)

Residuals:
   Min     1Q Median     3Q    Max 
-66.51 -18.43   0.00  26.90  67.76 

Coefficients:
                          Estimate Std. Error t value Pr(&gt;|t|)
(Intercept)                 -74.21     149.80  -0.495    0.638
overlap_LF_mm3               45.11      34.61   1.303    0.240
overlap_AL_mm3             -724.57     795.09  -0.911    0.397
Age                         -11.21      24.25  -0.462    0.660
SDR                         -46.76      25.51  -1.833    0.116
`Sonications (delivered)`    16.77      16.48   1.018    0.348
`MaxAv Temp`                 43.01      27.41   1.569    0.168

Residual standard error: 54.83 on 6 degrees of freedom
  (14 observations deleted due to missingness)
Multiple R-squared:  0.6362,    Adjusted R-squared:  0.2724 
F-statistic: 1.749 on 6 and 6 DF,  p-value: 0.2569</code></pre>
</div>
</div>
<p>Given these results I decided to repeat linear regressions with one predictor at a time to hopefully increase certainty of correlations when removing adjustments for the covariates. While the results are a bit more precise, they remain not statistically significant and carry a large amount of uncertainty. It is still encouraging to see results consistent with our previous analyses.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>predictors <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"overlap_LF_mm3"</span>,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"overlap_AL_mm3"</span>,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Age"</span>,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SDR"</span>,</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"`Sonications (delivered)`"</span>,</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"`MaxAv Temp`"</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>lm_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(predictors, <span class="cf">function</span>(var) {</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">"pct_improve ~"</span>, var))</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">lm</span>(formula, <span class="at">data =</span> dat)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(model)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(lm_results) <span class="ot">&lt;-</span> predictors</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>lm_table <span class="ot">&lt;-</span> <span class="fu">lapply</span>(predictors, <span class="cf">function</span>(var) {</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>  formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">"pct_improve ~"</span>, var))</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>(<span class="fu">lm</span>(formula, <span class="at">data =</span> dat)) <span class="sc">%&gt;%</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(term <span class="sc">!=</span> <span class="st">"(Intercept)"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">predictor =</span> var)</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>()</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>lm_table_nice <span class="ot">&lt;-</span> lm_table <span class="sc">%&gt;%</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">Predictor =</span> predictor,</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">Estimate =</span> estimate,</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Std. Error</span><span class="st">`</span> <span class="ot">=</span> std.error,</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">t value</span><span class="st">`</span> <span class="ot">=</span> statistic,</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">p value</span><span class="st">`</span> <span class="ot">=</span> p.value</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>  lm_table_nice,</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">digits =</span> <span class="dv">3</span>,</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">caption =</span> <span class="st">"Univariable linear regression models predicting percent clinical improvement"</span></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Univariable linear regression models predicting percent clinical improvement</caption>
<colgroup>
<col style="width: 29%">
<col style="width: 10%">
<col style="width: 12%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 29%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">term</th>
<th style="text-align: right;">Estimate</th>
<th style="text-align: right;">Std. Error</th>
<th style="text-align: right;">t value</th>
<th style="text-align: right;">p value</th>
<th style="text-align: left;">Predictor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">overlap_LF_mm3</td>
<td style="text-align: right;">2.218</td>
<td style="text-align: right;">2.190</td>
<td style="text-align: right;">1.013</td>
<td style="text-align: right;">0.333</td>
<td style="text-align: left;">overlap_LF_mm3</td>
</tr>
<tr class="even">
<td style="text-align: left;">overlap_AL_mm3</td>
<td style="text-align: right;">32.330</td>
<td style="text-align: right;">69.209</td>
<td style="text-align: right;">0.467</td>
<td style="text-align: right;">0.650</td>
<td style="text-align: left;">overlap_AL_mm3</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Age</td>
<td style="text-align: right;">-1.599</td>
<td style="text-align: right;">1.461</td>
<td style="text-align: right;">-1.095</td>
<td style="text-align: right;">0.295</td>
<td style="text-align: left;">Age</td>
</tr>
<tr class="even">
<td style="text-align: left;">SDR</td>
<td style="text-align: right;">-115.734</td>
<td style="text-align: right;">183.064</td>
<td style="text-align: right;">-0.632</td>
<td style="text-align: right;">0.539</td>
<td style="text-align: left;">SDR</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>Sonications (delivered)</code></td>
<td style="text-align: right;">16.738</td>
<td style="text-align: right;">10.801</td>
<td style="text-align: right;">1.550</td>
<td style="text-align: right;">0.147</td>
<td style="text-align: left;"><code>Sonications (delivered)</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>MaxAv Temp</code></td>
<td style="text-align: right;">3.704</td>
<td style="text-align: right;">5.846</td>
<td style="text-align: right;">0.634</td>
<td style="text-align: right;">0.538</td>
<td style="text-align: left;"><code>MaxAv Temp</code></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Next, I attempted to fit a logistic regression to predict response outcome (binary), using the same variables used previously. The results make it clear that the data does not support this model. This model cannot handle separation, and the predictors separate responders from non-responders. This result is again a reflection of the limited sample size.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># logistic regression</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>model_glm <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  Response <span class="sc">~</span> overlap_LF_mm3 <span class="sc">+</span> overlap_AL_mm3 <span class="sc">+</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    Age <span class="sc">+</span> SDR <span class="sc">+</span> <span class="st">`</span><span class="at">Sonications (delivered)</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">MaxAv Temp</span><span class="st">`</span>,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dat,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> binomial</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_glm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = Response ~ overlap_LF_mm3 + overlap_AL_mm3 + Age + 
    SDR + `Sonications (delivered)` + `MaxAv Temp`, family = binomial, 
    data = dat)

Coefficients:
                            Estimate Std. Error z value Pr(&gt;|z|)
(Intercept)               -1.599e+03  2.013e+06  -0.001    0.999
overlap_LF_mm3            -5.431e+00  1.288e+04   0.000    1.000
overlap_AL_mm3             3.305e+01  4.438e+05   0.000    1.000
Age                        2.078e+00  4.221e+03   0.000    1.000
SDR                       -5.713e+02  8.932e+05  -0.001    0.999
`Sonications (delivered)` -1.742e+01  4.252e+04   0.000    1.000
`MaxAv Temp`               3.675e+01  4.555e+04   0.001    0.999

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 1.6220e+01  on 17  degrees of freedom
Residual deviance: 9.7421e-10  on 11  degrees of freedom
  (9 observations deleted due to missingness)
AIC: 14

Number of Fisher Scoring iterations: 25</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(model_glm, <span class="at">exponentiate =</span> <span class="cn">TRUE</span>, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 7
  term                 estimate std.error statistic p.value  conf.low  conf.high
  &lt;chr&gt;                   &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;
1 (Intercept)         0          2012860.  -7.94e-4   0.999 0         Inf       
2 overlap_LF_mm3      4.38e-  3    12878.  -4.22e-4   1.000 0         Inf       
3 overlap_AL_mm3      2.27e+ 14   443823.   7.45e-5   1.000 0         Inf       
4 Age                 7.99e+  0     4221.   4.92e-4   1.000 8.23e-183   6.88e168
5 SDR                 7.83e-249   893249.  -6.40e-4   0.999 0         Inf       
6 `Sonications (deli… 2.72e-  8    42519.  -4.10e-4   1.000 0         Inf       
7 `MaxAv Temp`        9.15e+ 15    45552.   8.07e-4   0.999 0         Inf       </code></pre>
</div>
</div>
<p>Following the poor fit from above, I switched to a random forest model for a new approach using non-linear relationships.</p>
<p>To review, the MeanDecreaseGini measures how much a variable increases node purity across trees, so a higher value is equal to a greater contribution to classification accuracy. The variables with the highest MeanDecreaseGini (SDR, max avg temp), contribute most strongly to separating responders from non-responders in the generated forest. While LF overlap is not among the highest variables, it still demonstrates some contribution to classification.</p>
<p>MeanDecreaseAccuracy measures how much a variable contributes to predictive accuracy in a random forest. This shows max avg temp, age, and oddly AL overlap as the most important variables for prediction.</p>
<p>The ROC curve with AUC = 0.667 indicates that the model has a meaningful but limited ability to discriminate responders from non-responders using all predictors.</p>
<p>I could not draw any strong conclusions from this analysis, but the trends remain encouraging given our very small sample size.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># random forest classification</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>rf_dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    Response,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    overlap_LF_mm3,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    overlap_AL_mm3,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    Age,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    SDR,</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Sonications (delivered)</span><span class="st">`</span>,</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">MaxAv Temp</span><span class="st">`</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>rf_dat2 <span class="ot">&lt;-</span> rf_dat <span class="sc">%&gt;%</span> <span class="co"># I could not get random forest to work without changing the naming of the last two variables added to analysis</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">Sonications_delivered =</span> <span class="st">`</span><span class="at">Sonications (delivered)</span><span class="st">`</span>,</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">MaxAv_Temp =</span> <span class="st">`</span><span class="at">MaxAv Temp</span><span class="st">`</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>rf_dat2<span class="sc">$</span>Response <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(rf_dat2<span class="sc">$</span>Response)</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>rf_model <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>  Response <span class="sc">~</span> .,</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> rf_dat2,</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">ntree =</span> <span class="dv">500</span>,</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">importance =</span> <span class="cn">TRUE</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a><span class="fu">varImpPlot</span>(rf_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="BMIN5030_FinalProject_Ballard_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>rf_dat2<span class="sc">$</span>rf_pred <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">predict</span>(rf_model, <span class="at">type =</span> <span class="st">"prob"</span>)[, <span class="st">"1"</span>])</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>roc_rf <span class="ot">&lt;-</span> <span class="fu">roc</span>(rf_dat2<span class="sc">$</span>Response, rf_dat2<span class="sc">$</span>rf_pred)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>auc_rf <span class="ot">&lt;-</span> <span class="fu">auc</span>(roc_rf)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(roc_rf, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lwd =</span> <span class="dv">2</span>,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="fu">sprintf</span>(<span class="st">"ROC curve (AUC = %.3f)"</span>, auc_rf))</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"gray"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="BMIN5030_FinalProject_Ballard_files/figure-html/unnamed-chunk-16-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>For the last model, I performed a univariable generalized linear model just for LF overlap. This was a nice way to visualize the directional association between increased LF overlap and increased predicted response probability that our data indicates. Of course, this is not statistically significant, does not indicate causality, and comes with a good deal of uncertainty still.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>glm_lf <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  Response <span class="sc">~</span> overlap_LF_mm3,</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dat,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> binomial</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>predicted_prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(glm_lf, <span class="at">newdata =</span> dat, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> overlap_LF_mm3, <span class="at">y =</span> predicted_prob, <span class="at">color =</span> Response)) <span class="sc">+</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"glm"</span>, <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">family =</span> <span class="st">"binomial"</span>), <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"LF overlap (mm³)"</span>,</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted probability of response"</span>,</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Predicted response probability vs LF overlap"</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="BMIN5030_FinalProject_Ballard_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="limitations" class="level2">
<h2 class="anchored" data-anchor-id="limitations">Limitations</h2>
<p>This study has significant limitations. First, the sample size was small, reflecting the exploratory nature of focused ultrasound pallidotomy cohorts, which limited statistical power and prevented reliable inference in adjusted multivariable models. As a result, most analyses were underpowered to detect modest effect sizes, and confidence intervals were wide. Missing clinical or procedural data further reduced the number of complete cases available for modeling. We were surprised at the amount of missing UPDRS scores and found that some subjects were being marked as having responded due to their obvious reduction or resolution of symptoms, but they were not formally examined for a new UPDRS score. This was an important realization for this relatively new patient cohort, especially if the clinical team intends to eventually inform their practice with real-time data analyses from the provided pipeline.</p>
<p>Second, overlap metrics were derived from post-hoc image registration and atlas-based tract masks, which are inherently sensitive to registration accuracy, image resolution, and atlas assumptions. While standard preprocessing pipelines were applied, small spatial errors could influence estimated tract overlap, particularly for narrow white matter pathways such as those involved in this project. We still are considering re-assessing overlap metrics using tractograms developed from patient-specific diffusion imaging rather than a standardized atlas, but this workflow needs to be investigated further before finalization and potential implementation.</p>
<p>Third, clinical outcome measures were simplified to binary response and percent improvement metrics, which may not fully capture the multidimensional nature of Parkinson’s Disease symptom change. Potential confounders such as disease duration, medication state, and baseline symptom severity were not included in the present analyses, though they are intended to be explored in future analyses.</p>
<p>Finally, predictive modeling results, particularly from random forest classification, reflect in-sample performance and exploratory signal detection rather than validated clinical prediction. Although machine learning approaches were robust to separation and small sample size, their outputs should be interpreted as hypothesis-generating rather than clinically actionable.</p>
</section>
<section id="conclusion-and-future-directions" class="level2">
<h2 class="anchored" data-anchor-id="conclusion-and-future-directions">Conclusion and Future Directions</h2>
<p>In this exploratory neuroimaging analysis, greater overlap between focused ultrasound ablation fields and pallidal output pathways, specifically the lenticular fasciculus, was consistently associated with improved clinical outcomes across multiple analytic approaches. Although no single predictor reached statistical significance in models, the directional consistency observed across univariable regression, multivariable modeling, and random forest classification suggests that anatomical coverage of specific white matter pathways may contribute to treatment response.</p>
<p>These findings support the hypothesis that symptom improvement following pallidothalamic tract ablation is influenced not only by lesion location but by coverage of functionally relevant fiber tracts. Importantly, nonparametric machine learning approaches demonstrated modest but above-chance discriminatory performance, highlighting their utility in small, heterogeneous clinical datasets where traditional regression models may fail.</p>
<p>Future work will focus on expanding cohort size, increasing the availability of clinical outcomes data, and refining tract-specific targeting metrics using subject-specific diffusion imaging when available. Validation of these findings in independent datasets will be critical to determining whether tract overlap measures can inform focused ultrasound treatment targeting strategies for Parkinson’s disease.</p>
<p>I would like to express enormous gratitude to Dr.&nbsp;Liming Qiu for her guidance and collaboration on this project, and to Dr.&nbsp;Casey Halpern and his lab for all of their support throughout.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>